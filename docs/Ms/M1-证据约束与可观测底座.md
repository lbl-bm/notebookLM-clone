# M1 里程碑：证据约束与可观测底座

## 1. 里程碑定位

### 1.1 目标

M1 的目标不是“让答案更华丽”，而是先让系统具备以下基础能力：

- 回答可追溯：每个核心结论都能指向已检索证据。
- 风险可控：低置信场景不强答，优先拒答或保守回答。
- 性能可见：从检索到生成全链路有统一指标与日志。
- 可灰度可回滚：新策略可按范围开启，异常可快速退回旧链路。

### 1.2 范围边界

- **纳入**：Chat 主链路、Studio 精准链路、日志与指标、最小评测机制。
- **暂不纳入**：跨编码器精排、多路检索融合、事实级自动校验（放入 M2/M3）。

### 1.3 成功标准（摘要）

- 幻觉率显著下降（以人工抽检与离线集联合评估）。
- 无依据回答比例下降，拒答准确率上升。
- 可输出每次请求的检索质量与生成耗时画像。

### 1.4 当前阶段约束（2026-02）

- 当前团队人力有限，M1 需优先交付“可落地最小闭环”，避免一次性引入高复杂度后处理链路。
- M1 目标聚焦在线路稳定性与可观测，不要求建设完整离线评测平台。
- 所有新增能力必须支持配置开关与快速回退。

---

## 2. 架构改造概览

### 2.1 改造前问题

- 检索结果虽有 citations，但“回答句子 ↔ 证据片段”未强绑定。
- 低置信场景仅有粗粒度控制，缺乏标准化拒答判定。
- 日志偏开发态，缺少可运营指标与统一事件模型。

### 2.2 改造后链路

1. 用户问题进入 Chat/Studio。
2. 检索阶段输出候选证据 + 置信度。
3. 证据压缩与去重后，进入“证据约束生成模板”。
4. 生成阶段按“结论-证据”结构输出中间结果。
5. 后处理阶段校验引用完整性与最小一致性。
6. 未过校验时触发降级：保守回答或拒答。
7. 全流程写入统一 trace 与指标。

---

## 3. 模块文件改造清单

## 3.1 `app/api/chat/route.ts`

### 目标

将当前“检索-拼 Prompt-直接流式返回”升级为“检索-证据约束生成-校验-输出”。

### 变更点

- 引入请求级 `traceId` 和策略版本号。
- 在检索结果后增加“证据充分性判断”节点。
- 生成前插入“答案契约”约束（要求结论绑定证据编号）。
- 生成后插入“引用一致性检查器”。
- 对低置信度与校验失败结果执行降级路径。
- 在消息持久化中追加关键诊断字段（不破坏既有字段）。

### 注意

- 保持现有流式输出协议兼容前端。
- 新增的校验步骤需要支持超时保护，避免拖慢首包延迟。

## 3.2 `lib/rag/retriever.ts`

### 目标

统一输出证据质量信号，为生成层提供可解释控制输入。

### 变更点

- 扩展检索返回结构：加入 coverage、sourceDiversity、scoreGap 等诊断指标。
- 置信度计算从“单分数”升级为“分项评分 + 总评分”。
- 增加最小证据集合选择策略（优先覆盖不同来源与段落）。
- 暴露标准化的 `retrievalDecision`（grounded / uncertain / no_evidence）。

### 注意

- 保持 `retrieveChunks` 与 `hybridRetrieveChunks` 的入参兼容。
- 去重逻辑升级为“语义去重 + 位置信息去重”的组合规则。

## 3.3 `lib/rag/prompt.ts`

### 目标

从“引用建议”升级为“引用强约束”。

### 变更点

- 新增“答案契约模板”与“失败回退模板”。
- Chat 不同问题类型复用统一证据规则，减少模板漂移。
- 约束回答结构：
  - 结论区
  - 证据区（按编号映射）
  - 不确定性声明区（必要时）

### 注意

- 仍保留现有动态分类逻辑，作为约束模板选择器而非自由发挥提示词。

## 3.4 `lib/studio/generator.ts`

### 目标

让 Studio 精准模式输出具备证据归因能力。

### 变更点

- Map 阶段要求每个来源输出“要点 + 证据定位信息”。
- Reduce 阶段对来源冲突执行“冲突声明”而非强行合并。
- 结果中附带最小可追溯元信息（sourceId / chunkIndex 范围映射）。

### 注意

- 不改变现有 Artifact 类型与前端展示协议。
- 对 `quiz`、`mindmap` 保持 JSON 解析兼容。

## 3.5 `lib/utils/logger.ts`

### 目标

从开发日志升级为可运营指标日志。

### 变更点

- 新增标准事件类型：ingest、retrieve、rerank、generate、validate、fallback。
- 日志结构统一携带：traceId、notebookId、model、latency、status、reason。
- 支持采样率配置，避免高并发日志膨胀。

### 注意

- 生产环境保留 error + 关键业务统计日志。
- 开发环境可全量输出用于调试。

## 3.6 `lib/config.ts`

### 目标

增加 M1 策略开关与灰度参数。

### 建议新增配置项

- `RAG_EVIDENCE_CONSTRAINT_ENABLED`
- `RAG_MIN_EVIDENCE_COUNT`
- `RAG_CONFIDENCE_FALLBACK_THRESHOLD`
- `RAG_VALIDATION_TIMEOUT_MS`
- `RAG_LOG_SAMPLING_RATE`
- `RAG_STRATEGY_VERSION`

---

## 4. 数据与持久化设计

### 4.1 Message 元数据增强（兼容扩展）

在 `messages.metadata` 中新增建议字段：

- traceId
- retrievalDecision
- evidenceStats
- validationStats
- fallbackReason
- strategyVersion

### 4.2 检索详情结构标准化

`retrievalDetails` 统一为可分析结构：

- query 画像
- chunk 质量分布
- source 覆盖情况
- 阈值命中情况
- 最终决策与原因

### 4.3 指标聚合建议

短期可先写数据库/日志，后续对接指标平台：

- grounded_answer_rate
- no_evidence_rate
- low_confidence_rate
- citation_validation_fail_rate
- p50/p95_retrieval_ms
- p50/p95_generation_ms

---

## 5. 接口与契约（不写代码，定义行为）

### 5.1 Chat 输出契约

- 必须包含回答正文。
- 可选包含 citations（按既有协议）。
- 新增可选 diagnostics（仅内部/调试可见）。
- 当证据不足时，answerMode 必须明确标记。

### 5.2 Studio 输出契约

- 保持现有内容格式。
- 新增内部可选字段：evidenceMap（用于后续 UI 增强）。

### 5.3 失败与降级契约

- 检索失败：返回保守错误提示，不调用生成模型。
- 校验失败：优先降级为“谨慎回答”，必要时拒答。
- 生成超时：返回部分结果时需明确完整性状态。

---

## 6. 验收标准（详细）

### 6.1 功能验收

- 回答中的关键结论可在引用片段中找到证据依据。
- 低置信度问题触发拒答或不确定声明。
- Studio 精准产物能回溯来源范围。

### 6.2 质量验收

- 幻觉样本率较基线下降。
- 引用失配率降低。
- 无依据强答率降低。

### 6.3 性能验收

- 首包延迟增幅可控。
- p95 总时延在可接受范围内（由团队定义阈值）。
- 新增校验步骤不导致大面积超时。

### 6.4 稳定性验收

- 灰度范围内无显著错误峰值。
- 关键失败路径均有可解释日志。
- 回滚后系统可恢复到基线行为。

---

## 7. 实施计划（建议 2 周）

### 周 1

- 完成 traceId、策略版本号、结构化检索诊断字段接入。
- 打通日志与关键延迟指标采集（不引入独立评测平台）。
- 完成证据充分性判定与降级分支的最小实现。

### 周 2

- 联调 Chat + Studio，保证协议兼容与降级可用。
- 小流量灰度验证，记录 baseline 指标。
- 根据灰度结果修正阈值与策略参数。

### 周 3（缓冲与稳态）

- 修复灰度暴露问题，压缩异常路径。
- 固化 M1 基线报告（以日志统计与人工抽检为主）。
- 为 M2 输出可复用的检索诊断字段标准。

---

## 8. 已识别缺陷与修正方案（补充）

### 8.1 主要缺陷

- **流式链路与生成后校验冲突**：若先完整生成再校验，会牺牲首包延迟。
- **日志平台假设过重**：当前阶段不具备完整可观测平台，直接全量落库成本高。
- **成功标准缺少基线阈值**：仅写“显著下降”不可执行。

### 8.2 修正方案

- 采用“双通道策略”：保留流式输出；校验作为后置诊断，不阻断首包。
- 指标采集以结构化日志为主，仅保留关键聚合字段，避免高频明细全量入库。
- 补充最小量化目标（建议）：
  - 无依据强答率较当前版本下降 20%+
  - citation 失配率下降 15%+
  - p95 总时延增幅控制在 15% 以内

### 8.3 M1 最小可交付范围（MVP）

- 必做：证据约束模板、低置信降级、traceId 与 diagnostics。
- 可选：生成后一致性检查器（默认仅记录，不阻断）。
- 暂缓：完整离线评测平台与自动化发布门禁。

---

## 9. 风险与回滚

### 8.1 主要风险

- 约束过强导致回答过短或频繁拒答。
- 校验步骤增加时延。
- 日志增加带来存储与查询压力。

### 8.2 回滚策略

- 配置级关闭证据约束，恢复旧 Prompt 流程。
- 关闭后处理校验，仅保留检索结果输出。
- 保留 trace 日志结构，便于回溯问题。

---

## 10. 里程碑完成定义（DoD）

- 代码路径中已存在证据约束、校验与降级闭环。
- 线上可查看关键质量与性能指标。
- 有可复用的 M1 基线评测报告，可作为 M2 对照组。
