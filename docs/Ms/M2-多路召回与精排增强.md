# M2 里程碑：多路召回与精排增强

## 1. 里程碑定位

### 1.1 目标

在 M1“可控与可观测”基础上，M2 重点解决“召回不稳、相关性漂移、上下文污染”问题：

- 提升跨领域问题的证据命中率与覆盖率。
- 降低同义问题、长尾问题、复杂多子问题的检索漏召。
- 在可控成本下提升重排质量。

### 1.2 范围边界

- **纳入**：查询改写、多路召回、候选融合、精排、上下文预算器。
- **暂不纳入**：事实级自动校验与自动修复（放在 M3）。

### 1.3 成功标准（摘要）

- Recall@K、nDCG、人工相关性评分较 M1 提升。
- 同样 token 预算下，答案引用质量更高。
- 检索稳定性提升（同义问法波动减小）。

### 1.4 当前阶段约束（2026-02）

- 当前人力不足，M2 以“低风险增益”优先，不强制一次性落地完整两阶段精排。
- 默认不引入额外高频 LLM 调用（如重度 Query Rewrite / claim 级后处理）。
- 所有能力需可按开关降级到 M1 稳定链路。

---

## 2. 架构改造概览

### 2.1 改造前问题

- 当前检索主路径以向量检索为核心，混合检索虽然存在但候选策略仍偏单一路径。
- 重排以 MMR 为主，缺乏语义精排器。
- topK 固定，无法根据问题复杂度动态调整。

### 2.2 改造后链路

1. Query 进入“意图解析 + 改写器”（原问、扩展问、关键词问）。
2. 多路并行召回：Dense、Sparse、Metadata Filter 路由。
3. 候选融合：去重、归一化打分、来源多样性控制。
4. 两阶段重排：
   - 阶段 1：轻量 MMR 去冗余
   - 阶段 2：语义精排器（可配置）
5. 上下文预算器按问题复杂度分配上下文。
6. 输出最小证据集合供生成模块使用。

---

## 3. 模块文件改造清单

## 3.1 `lib/rag/retriever.ts`

### 目标

升级为“检索编排器”，不再只是一条检索函数。

### 变更点

- 增加 Query Rewrite 子流程：
  - 原始查询
  - 关键词提炼查询
  - 意图扩展查询（同义/上下位）
- 增加多路召回函数：
  - denseRetrieve
  - sparseRetrieve
  - filteredRetrieve
- 候选融合器：统一分数归一化、来源多样性惩罚、近重复折损。
- 重排器拆分：
  - MMR 作为 stage1
  - reranker 作为 stage2（可开关）
- 输出结构新增：
  - queryVariants
  - routeStats
  - rankTrace
  - contextBudgetPlan

### 注意

- 保留现有 `retrieveChunks` 对外签名，内部切换至新编排器。
- 将 M1 的 `retrievalDecision` 与 M2 质量信号保持兼容。

## 3.2 `lib/db/vector-store.ts`

### 目标

优化候选召回效率与 SQL 可预测性。

### 变更点

- 将 hybridSearch 改造为“候选分层召回”：
  - 向量索引先召回候选池
  - 稀疏检索召回候选池
  - 合并后统一排序
- 增加查询策略参数：candidatePoolSize、useFtsFallback、minScoreCutoff。
- 对 sourceIds 与 notebookId 过滤顺序做稳定化优化。
- 输出额外诊断字段：rawRank、routeType、scoreBeforeNormalize。

### 注意

- 不破坏已有 pgvector/HNSW 使用方式。
- 保持 SQL 注入安全与参数化约束。

## 3.3 `lib/rag/prompt.ts`

### 目标

适配“动态上下文预算 + 证据分组输入”。

### 变更点

- 上下文按主题簇组织，而非简单拼接 chunk 列表。
- 在 system 约束中加入“优先使用高一致性证据组”的规则。
- 明确禁止引用低分证据组中的强结论。

### 注意

- 保持 M1 的答案契约一致，避免新增模板导致不一致。

## 3.4 `app/api/chat/route.ts`

### 目标

接入新检索编排，并输出可回溯的检索路径。

### 变更点

- 请求中支持检索策略版本与路由策略选择（内部配置驱动）。
- metadata 中追加 routeStats、rerankStats、budgetStats。
- 低延迟场景可跳过 stage2 精排（按策略开关）。

### 注意

- 继续保证流式协议稳定。
- 新增诊断信息默认仅内部可见。

## 3.5 `lib/config.ts`

### 目标

新增 M2 的检索策略参数。

### 建议新增配置项

- `RAG_QUERY_REWRITE_ENABLED`
- `RAG_RETRIEVE_CANDIDATE_POOL_SIZE`
- `RAG_RERANK_STAGE2_ENABLED`
- `RAG_RERANK_TOPN`
- `RAG_DYNAMIC_TOPK_ENABLED`
- `RAG_CONTEXT_BUDGET_MAX_TOKENS`
- `RAG_ROUTE_TIMEOUT_MS`

## 3.6 `prisma/migrations/*`

### 目标

按需增强查询性能与过滤能力。

### 建议方向

- 校验并补齐 `document_chunks` 的过滤与排序相关索引。
- 若引入 metadata 过滤高频字段，考虑表达式索引或部分索引。
- 建议保留变更日志，标注每条索引对应查询模式。

---

## 4. 数据与持久化设计

### 4.1 检索诊断结构增强

建议在消息 metadata 中新增：

- queryVariants（改写列表）
- routeStats（每条召回路径命中）
- fusionStats（候选合并前后规模）
- rerankStats（stage1/stage2 耗时与重排幅度）
- budgetStats（上下文分配与截断情况）

### 4.2 候选池管理

- 候选池分级：高置信候选、补充候选、探索候选。
- 记录每个候选来源路径，支持后续误召回分析。

### 4.3 多样性控制

- 记录 source 覆盖率、section 覆盖率。
- 限制单来源过度占比，避免上下文单一。

---

## 5. 接口与契约（不写代码，定义行为）

### 5.1 检索编排契约

输入：notebookId、query、可选 sourceIds、策略参数。
输出：

- finalChunks（供生成）
- retrievalDecision
- diagnostics（路线、评分、预算）

### 5.2 重排契约

- stage1 输出用于多样性筛选。
- stage2 输出用于最终相关性排序。
- 两阶段都需要可开关、可降级。

### 5.3 上下文预算契约

- 按问题类型分配 token 配额。
- 当预算不足时，优先保留高质量证据组。
- 记录被裁剪证据，便于调试。

---

## 6. 验收标准（详细）

### 6.1 功能验收

- 同一问题不同表达方式，检索结果一致性提升。
- 多跳问题可召回来自不同来源的互补证据。
- 重排后结果质量优于仅 MMR 基线。

### 6.2 质量验收

- Recall@K、MRR、nDCG 达到目标增幅。
- 人工评测中“证据相关性”评分提升。
- 上下文噪音比例下降。

### 6.3 性能验收

- 多路召回后 p95 检索时延在预算内。
- stage2 精排开关对时延影响可预测。
- 动态 topK 不造成整体成本失控。

### 6.4 稳定性验收

- 任一路由失败可降级至可用结果。
- 日志可完整还原本次召回与重排路径。
- 灰度扩大后无明显质量回退。

---

## 7. 实施计划（建议 2-3 周，分层交付）

### M2a（第 1-2 周，必做）

- 完成候选融合（归一化打分、去重、多样性约束）。
- 接入上下文预算器与动态 topK。
- 输出 routeStats/fusionStats/budgetStats，形成可比对诊断数据。

### M2b（第 3 周，可选）

- 引入轻量 Query Rewrite（优先规则/关键词提炼）。
- 评估并按需开启 stage2 精排（默认关闭，灰度启用）。
- 进行灰度与压测，确认收益是否覆盖成本。

---

## 8. 已识别缺陷与修正方案（补充）

### 8.1 主要缺陷

- **Query Rewrite 成本与时延不确定**：若依赖额外 LLM 调用，延迟与费用会明显上升。
- **stage2 精排器来源不清**：在当前部署形态下，本地重模型部署成本高。
- **范围过大且并行项过多**：原计划将多路召回、重排、预算器同时推进，风险高。

### 8.2 修正方案

- Query Rewrite 先采用规则/关键词提炼方案，LLM 改写作为可选实验开关。
- stage2 精排默认关闭，仅在灰度样本验证有效后逐步放量。
- 以 M2a/M2b 分层推进，先交付融合 + 预算器，再评估是否做深度精排。

### 8.3 成本与时延控制建议

- 增加每请求检索链路预算：route timeout、candidate pool 上限、rerank topN 上限。
- 设定 M2 阶段目标：
  - 检索侧 p95 增幅不超过 20%
  - 单请求平均 token 成本增幅不超过 15%
  - 召回质量指标（Recall@K / 人工相关性）显著提升后再扩量

---

## 9. 风险与回滚

### 8.1 主要风险

- 多路召回带来时延和成本上升。
- 改写质量不稳引入噪音。
- 精排器收益不及预期。

### 8.2 回滚策略

- 关闭改写，退回原始查询。
- 关闭 stage2 精排，仅保留 stage1 + 基线检索。
- 将 candidatePoolSize 回调到 M1 默认值。

---

## 10. 里程碑完成定义（DoD）

- 检索链路至少具备“多路召回 + 候选融合 + 上下文预算器”能力。
- 在可控成本下，关键质量指标稳定优于 M1。
- 两阶段重排为可选增强项，需有灰度收益证明后再默认开启。
