# US-007: 引文高亮与来源定位

## 用户故事
作为一个**Notebook 用户**，我希望能够**点击引用来源并查看原文**，以便**验证 AI 回答的准确性**。

## 验收标准

### 场景 1：引用卡片展示
- [x] 每条 AI 回复下方应该显示引用列表
- [x] 每个引用卡片包含：
  - 📄 Source 图标和名称
  - 📊 相关度分数（如 "相关度: 85%"）
  - 📝 引用片段（前 100 字，超出显示省略号）
  - 📍 定位信息：
    - PDF: "第 5 页"
    - 网页: 显示 URL 域名
- [x] 引用按相关度从高到低排序

### 场景 2：点击引用定位
- [x] 当我点击引用卡片时：
  - 左侧 Sources 面板应该自动展开
  - 对应的 Source 应该高亮显示
  - Source 详情抽屉应该打开
  - 引用的段落应该高亮显示（黄色背景）
  - 页面应该自动滚动到高亮段落

### 场景 3：Source 详情抽屉
- [x] 抽屉应该显示：
  - Source 完整信息（文件名、页数、上传时间）
  - 引用段落的上下文（前后各 1 段）
  - 段落在文档中的位置（如 "第 5 页，第 3 段"）
- [ ] 我可以在抽屉中滚动查看完整文档内容（分页加载）

### 场景 4：多个引用来源
- [x] 如果 AI 回答引用了多个 Sources，我应该看到多个引用卡片
- [x] 每个卡片应该清晰标注来自哪个 Source
- [x] 我可以依次点击查看不同来源

### 场景 5：引用片段高亮
- [ ] 在 AI 回答的文本中，引用的内容应该有视觉标记
- [ ] 鼠标悬停在标记上时，应该显示 tooltip："来自《文件名》第 X 页"
- [ ] 点击标记应该跳转到对应引用卡片

### 场景 6：无引用情况
- [x] 如果 AI 拒答（无依据），应该显示：
  - ⚠️ "未找到相关依据"
  - 建议："上传更多资料或缩小问题范围"
- [x] 不应该显示引用卡片

## 技术约束
- Citations 结构：
  ```typescript
  {
    chunkId: number,
    sourceId: string,
    score: number,
    locator: { page?: number, url?: string },
    excerpt: string
  }
  ```
- 使用 `content_hash` 去重相同内容的引用
- 高亮使用 CSS `::target` 伪类或 JavaScript 滚动

## UI 组件
- `CitationCard` - 引用卡片
- `CitationHighlight` - 文本中的引用标记
- `SourceDetailDrawer` - Source 详情抽屉

## 依赖
- US-006 (RAG 问答)
- Citations 数据结构已定义

## 优先级
🔴 P0 - Week 4

## 估算
5 Story Points (2.5天)

## 测试用例
1. AI 回答包含 3 个引用 → 显示 3 个引用卡片，按分数排序
2. 点击第 2 个引用 → 左侧展开对应 Source，高亮段落
3. 鼠标悬停在回答中的引用标记 → 显示来源 tooltip
4. AI 拒答 → 显示"未找到依据"，无引用卡片
5. 相同内容的 chunk → 只显示一个引用（去重）
6. 点击 PDF 引用 → 显示"第 X 页"；点击网页引用 → 显示 URL

## 架构风险关联
- 🟡 8.3 Citations 去重（必须实现去重逻辑）


## 已实现的文件

```
components/notebook/
├── citation-context.tsx      # Citation 状态管理 Context
├── chat-panel.tsx            # 更新：内联引用标记渲染
├── source-sidebar.tsx        # 更新：引用详情视图
├── source-card.tsx           # 更新：添加高亮样式
└── notebook-content.tsx      # 更新：集成 CitationProvider

app/api/
└── sources/[id]/chunks/route.ts  # Chunk 上下文 API

lib/rag/
└── prompt.ts                 # 更新：System Prompt 引导 LLM 使用引用标记
```

## 实现说明

### 已完成功能
1. **内联引用标记** - AI 回答中自动插入 [1] [2] 等数字标记
2. **可点击标记** - 点击数字标记在左侧边栏展示引用详情
3. **Tooltip 提示** - 悬停显示来源名称和页码
4. **引用详情视图** - 在左侧边栏展示引用片段和位置信息
5. **引用卡片** - 底部显示所有引用来源，带编号
6. **无依据提示** - 显示警告图标和建议
7. **Citations 去重** - 基于内容前 100 字去重

### 交互流程
1. 用户提问 → AI 回答时自动插入引用标记 [1] [2]
2. 点击数字标记 → 左侧边栏切换到引用详情视图
3. 点击"返回来源列表" → 恢复 Source 列表视图
4. 底部引用卡片也可点击查看详情
