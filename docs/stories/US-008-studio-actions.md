# US-008: Studio åŠ¨ä½œç”Ÿæˆäº§ç‰©

## ç”¨æˆ·æ•…äº‹
ä½œä¸ºä¸€ä¸ª**Notebook ç”¨æˆ·**ï¼Œæˆ‘å¸Œæœ›èƒ½å¤Ÿ**ä¸€é”®ç”Ÿæˆç»“æ„åŒ–äº§ç‰©ï¼ˆæ‘˜è¦/å¤§çº²/æµ‹éªŒ/æ€ç»´å¯¼å›¾ï¼‰**ï¼Œä»¥ä¾¿**å¿«é€Ÿæ•´ç†å’Œå¤ä¹ çŸ¥è¯†**ã€‚

## éªŒæ”¶æ ‡å‡†

### åœºæ™¯ 1ï¼šæŸ¥çœ‹å¯ç”¨åŠ¨ä½œ
- [ ] å½“æˆ‘æ‰“å¼€ Notebook è¯¦æƒ…é¡µå³ä¾§ Studio é¢æ¿æ—¶ï¼Œæˆ‘åº”è¯¥çœ‹åˆ°ï¼š
  - Studio æ ‡é¢˜æ—è¾¹æœ‰ä¸€ä¸ªæ¨¡å¼é€‰æ‹©ä¸‹æ‹‰æ¡†ï¼š
    - âš¡ å¿«é€Ÿæ¨¡å¼ï¼ˆé»˜è®¤ï¼‰- æ™ºèƒ½é‡‡æ ·ï¼Œé€Ÿåº¦å¿«
    - ğŸ¯ ç²¾å‡†æ¨¡å¼ - Map-Reduceï¼Œè¦†ç›–æ›´å…¨é¢
  - ğŸ“„ ç”Ÿæˆæ‘˜è¦ - "å°†èµ„æ–™æµ“ç¼©ä¸ºç®€æ´æ‘˜è¦"
  - ğŸ“‹ ç”Ÿæˆå¤§çº² - "æå–ç»“æ„åŒ–çŸ¥è¯†æ¡†æ¶"
  - ğŸ“ ç”Ÿæˆæµ‹éªŒ - "ç”Ÿæˆé€‰æ‹©é¢˜æµ‹è¯•ç†è§£"
  - ğŸ§  ç”Ÿæˆæ€ç»´å¯¼å›¾ - "å¯è§†åŒ–çŸ¥è¯†ç»“æ„"
- [ ] æ¯ä¸ªåŠ¨ä½œæŒ‰é’®åº”è¯¥æ˜¾ç¤ºç®€çŸ­æè¿°
- [ ] å¦‚æœæ²¡æœ‰ ready çŠ¶æ€çš„ Sourcesï¼ŒæŒ‰é’®åº”è¯¥ç¦ç”¨å¹¶æç¤º"è¯·å…ˆä¸Šä¼ èµ„æ–™"
- [ ] æŒ‰é’®ä¸‹æ–¹æ˜¾ç¤º"åŸºäº X ä¸ªæ¥æº"ï¼ˆready çŠ¶æ€çš„ Source æ•°é‡ï¼‰
- [ ] æ¨¡å¼é€‰æ‹©ä¸‹æ‹‰æ¡† hover æ—¶æ˜¾ç¤º Tooltip è¯´æ˜ä¸¤ç§æ¨¡å¼çš„åŒºåˆ«

### åœºæ™¯ 2ï¼šç”Ÿæˆæ‘˜è¦
- [ ] å½“æˆ‘ç‚¹å‡»"ç”Ÿæˆæ‘˜è¦"æ—¶ï¼š
  - æŒ‰é’®æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼ˆSpinner + "ç”Ÿæˆä¸­..."ï¼‰
  - å…¶ä»–åŠ¨ä½œæŒ‰é’®ä¸´æ—¶ç¦ç”¨
  - ç”Ÿæˆå®Œæˆåï¼Œäº§ç‰©å‡ºç°åœ¨ä¸‹æ–¹äº§ç‰©åˆ—è¡¨é¡¶éƒ¨
  - äº§ç‰©è‡ªåŠ¨å±•å¼€æ˜¾ç¤ºå†…å®¹
- [ ] æ‘˜è¦æ ¼å¼ï¼ˆMarkdownï¼‰ï¼š
  ```markdown
  ## å†…å®¹æ‘˜è¦
  
  ### æ ¸å¿ƒä¸»é¢˜
  æœ¬èµ„æ–™ä¸»è¦ä»‹ç»äº†...
  
  ### å…³é”®è¦ç‚¹
  1. **è¦ç‚¹ä¸€**ï¼šè¯´æ˜...
  2. **è¦ç‚¹äºŒ**ï¼šè¯´æ˜...
  
  ### æ€»ç»“
  ç»¼ä¸Šæ‰€è¿°ï¼Œ...
  ```

### åœºæ™¯ 3ï¼šç”Ÿæˆå¤§çº²
- [ ] å½“æˆ‘ç‚¹å‡»"ç”Ÿæˆå¤§çº²"æ—¶ï¼š
  - æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  - ç”Ÿæˆå®Œæˆåäº§ç‰©å‡ºç°åœ¨åˆ—è¡¨é¡¶éƒ¨
- [ ] å¤§çº²æ ¼å¼ï¼ˆMarkdownï¼‰ï¼š
  ```markdown
  ## çŸ¥è¯†å¤§çº²
  
  ### ä¸€ã€[ä¸»é¢˜ä¸€]
  - 1.1 [å­ä¸»é¢˜]
    - è¦ç‚¹è¯´æ˜
  - 1.2 [å­ä¸»é¢˜]
  
  ### äºŒã€[ä¸»é¢˜äºŒ]
  - 2.1 [å­ä¸»é¢˜]
  ```

### åœºæ™¯ 4ï¼šç”Ÿæˆæµ‹éªŒ
- [ ] ç‚¹å‡»"ç”Ÿæˆæµ‹éªŒ"åï¼Œåº”è¯¥ç”Ÿæˆ 5-10 é“é€‰æ‹©é¢˜
- [ ] æµ‹éªŒæ•°æ®æ ¼å¼ï¼ˆJSONï¼‰ï¼š
  ```typescript
  interface Quiz {
    title: string
    questions: Array<{
      id: string
      question: string
      options: string[]  // ["A. ...", "B. ...", "C. ...", "D. ..."]
      answer: string     // "A" | "B" | "C" | "D"
      explanation: string
    }>
  }
  ```
- [ ] UI æ¸²æŸ“ä¸ºå¯äº¤äº’çš„æµ‹éªŒç•Œé¢ï¼š
  - æ˜¾ç¤ºé¢˜ç›®å’Œé€‰é¡¹ï¼ˆå•é€‰ï¼‰
  - é€‰æ‹©åæ˜¾ç¤ºæ­£ç¡®/é”™è¯¯åé¦ˆ
  - æ˜¾ç¤ºè§£æ
  - åº•éƒ¨æ˜¾ç¤ºå¾—åˆ†ç»Ÿè®¡ï¼ˆå¦‚ "8/10 æ­£ç¡®"ï¼‰
- [ ] æ”¯æŒ"é‡æ–°æµ‹éªŒ"æŒ‰é’®

### åœºæ™¯ 5ï¼šç”Ÿæˆæ€ç»´å¯¼å›¾
- [ ] ç‚¹å‡»"ç”Ÿæˆæ€ç»´å¯¼å›¾"åï¼Œç”Ÿæˆå¯è§†åŒ–çš„çŸ¥è¯†ç»“æ„å›¾
- [ ] æ€ç»´å¯¼å›¾æ•°æ®æ ¼å¼ï¼ˆJSONï¼‰ï¼š
  ```typescript
  interface MindMap {
    title: string
    root: MindMapNode
  }
  
  interface MindMapNode {
    id: string
    label: string
    children?: MindMapNode[]
    description?: string  // èŠ‚ç‚¹è¯¦ç»†è¯´æ˜ï¼ˆhover æ˜¾ç¤ºï¼‰
  }
  ```
- [ ] UI æ¸²æŸ“ä¸ºå¯äº¤äº’çš„æ€ç»´å¯¼å›¾ï¼š
  - ä½¿ç”¨æ ‘å½¢å¸ƒå±€æˆ–æ”¾å°„çŠ¶å¸ƒå±€
  - æ”¯æŒèŠ‚ç‚¹å±•å¼€/æ”¶èµ·
  - æ”¯æŒç¼©æ”¾å’Œæ‹–æ‹½
  - æ‚¬åœèŠ‚ç‚¹æ˜¾ç¤ºè¯¦ç»†è¯´æ˜
  - æ”¯æŒå¯¼å‡ºä¸º PNG å›¾ç‰‡
- [ ] æ€ç»´å¯¼å›¾å±‚çº§ï¼šæœ€å¤š 4 çº§ï¼ˆæ ¹èŠ‚ç‚¹ + 3 çº§å­èŠ‚ç‚¹ï¼‰

### åœºæ™¯ 6ï¼šäº§ç‰©ç®¡ç†
- [ ] äº§ç‰©åˆ—è¡¨æ˜¾ç¤ºï¼š
  - äº§ç‰©ç±»å‹å›¾æ ‡ï¼ˆğŸ“„æ‘˜è¦/ğŸ“‹å¤§çº²/ğŸ“æµ‹éªŒ/ğŸ§ æ€ç»´å¯¼å›¾ï¼‰
  - äº§ç‰©æ ‡é¢˜ï¼ˆè‡ªåŠ¨ç”Ÿæˆæˆ–"æ‘˜è¦ #1"ï¼‰
  - ç”Ÿæˆæ—¶é—´ï¼ˆç›¸å¯¹æ—¶é—´ï¼Œå¦‚"2åˆ†é’Ÿå‰"ï¼‰
  - é¢„è§ˆï¼ˆå‰ 80 å­— + ...ï¼Œæ€ç»´å¯¼å›¾æ˜¾ç¤ºèŠ‚ç‚¹æ•°ï¼‰
- [ ] ç‚¹å‡»äº§ç‰©å¡ç‰‡å±•å¼€/æ”¶èµ·å®Œæ•´å†…å®¹
- [ ] äº§ç‰©æ“ä½œï¼š
  - ğŸ“‹ å¤åˆ¶å†…å®¹åˆ°å‰ªè´´æ¿ï¼ˆæ˜¾ç¤º Toast æç¤ºï¼‰
  - ğŸ“¥ å¯¼å‡ºï¼ˆæ€ç»´å¯¼å›¾æ”¯æŒå¯¼å‡º PNGï¼‰
  - ğŸ—‘ï¸ åˆ é™¤äº§ç‰©ï¼ˆéœ€ç¡®è®¤ï¼‰
- [ ] äº§ç‰©åˆ—è¡¨æŒ‰åˆ›å»ºæ—¶é—´å€’åºæ’åˆ—

### åœºæ™¯ 7ï¼šé€‰æ‹© Sources èŒƒå›´ï¼ˆäºŒæœŸï¼‰
- [ ] åœ¨å·¦ä¾§ Sources åˆ—è¡¨ä¸­å¯å‹¾é€‰ç‰¹å®š Sources
- [ ] Studio é¢æ¿æ˜¾ç¤º"å·²é€‰æ‹© X ä¸ªæ¥æº"
- [ ] å¦‚æœå‹¾é€‰äº† Sourcesï¼ŒåªåŸºäºè¿™äº› Sources ç”Ÿæˆäº§ç‰©
- [ ] å¦‚æœæœªå‹¾é€‰ï¼ŒåŸºäºæ‰€æœ‰ ready çŠ¶æ€çš„ Sources

### åœºæ™¯ 8ï¼šäº§ç‰©æŒä¹…åŒ–
- [ ] ç”Ÿæˆçš„äº§ç‰©ä¿å­˜åˆ° `artifacts` è¡¨
- [ ] åˆ·æ–°é¡µé¢åäº§ç‰©åˆ—è¡¨ä¿ç•™
- [ ] åˆ é™¤äº§ç‰©åä»æ•°æ®åº“ç§»é™¤

### åœºæ™¯ 9ï¼šé”™è¯¯å¤„ç†
- [ ] API è°ƒç”¨å¤±è´¥æ—¶æ˜¾ç¤ºé”™è¯¯ Toast
- [ ] ç”Ÿæˆè¶…æ—¶ï¼ˆ60ç§’ï¼‰æ—¶æ˜¾ç¤ºè¶…æ—¶æç¤ºå¹¶æ”¯æŒé‡è¯•
- [ ] ç½‘ç»œé”™è¯¯æ—¶æç¤º"ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·é‡è¯•"
- [ ] JSON è§£æå¤±è´¥æ—¶æ˜¾ç¤º"ç”Ÿæˆæ ¼å¼å¼‚å¸¸ï¼Œè¯·é‡è¯•"

## æŠ€æœ¯çº¦æŸ

### æ•°æ®åº“è¡¨ç»“æ„ï¼ˆå·²å­˜åœ¨ï¼‰
```prisma
model Artifact {
  id         String   @id @default(uuid())
  notebookId String
  type       String   // 'summary' | 'outline' | 'quiz' | 'mindmap'
  input      Json     // { sourceIds: string[], prompt: string }
  content    String   @db.Text // Markdown æˆ– JSON
  createdAt  DateTime @default(now())

  notebook   Notebook @relation(...)
  @@map("artifacts")
}
```

### LLM é…ç½®
```typescript
// lib/config.ts å·²é…ç½®
{
  model: 'glm-4-flash',
  baseUrl: 'https://open.bigmodel.cn/api',
  apiKey: process.env.ZHIPU_API_KEY
}
```

### Prompt æ¨¡æ¿

#### æ‘˜è¦ Prompt
```typescript
const SUMMARY_PROMPT = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å†…å®¹æ‘˜è¦åŠ©æ‰‹ã€‚è¯·åŸºäºä»¥ä¸‹èµ„æ–™ç”Ÿæˆä¸€ä»½ç»“æ„åŒ–æ‘˜è¦ã€‚

è¦æ±‚ï¼š
1. æå–æ ¸å¿ƒä¸»é¢˜å’Œå…³é”®è¦ç‚¹ï¼ˆ3-5ä¸ªï¼‰
2. ä½¿ç”¨ Markdown æ ¼å¼
3. ä¿æŒå®¢è§‚å‡†ç¡®ï¼Œä¸æ·»åŠ èµ„æ–™ä¸­æ²¡æœ‰çš„ä¿¡æ¯
4. æ‘˜è¦é•¿åº¦æ§åˆ¶åœ¨ 300-500 å­—

è¾“å‡ºæ ¼å¼ï¼š
## å†…å®¹æ‘˜è¦

### æ ¸å¿ƒä¸»é¢˜
[ä¸€å¥è¯æ¦‚æ‹¬ä¸»é¢˜]

### å…³é”®è¦ç‚¹
1. **[è¦ç‚¹ä¸€]**ï¼š[è¯´æ˜]
2. **[è¦ç‚¹äºŒ]**ï¼š[è¯´æ˜]
3. **[è¦ç‚¹ä¸‰]**ï¼š[è¯´æ˜]

### æ€»ç»“
[æ€»ç»“æ€§é™ˆè¿°]

---
ä»¥ä¸‹æ˜¯å‚è€ƒèµ„æ–™ï¼š
{context}`
```

#### å¤§çº² Prompt
```typescript
const OUTLINE_PROMPT = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„çŸ¥è¯†æ•´ç†åŠ©æ‰‹ã€‚è¯·åŸºäºä»¥ä¸‹èµ„æ–™ç”Ÿæˆä¸€ä»½ç»“æ„åŒ–å¤§çº²ã€‚

è¦æ±‚ï¼š
1. æå–ä¸»è¦ä¸»é¢˜å’Œå­ä¸»é¢˜
2. ä½¿ç”¨å±‚çº§ç»“æ„ï¼ˆæœ€å¤š 3 çº§ï¼‰
3. æ¯ä¸ªè¦ç‚¹ç®€æ´æ˜äº†
4. ä½¿ç”¨ Markdown æ ¼å¼

è¾“å‡ºæ ¼å¼ï¼š
## çŸ¥è¯†å¤§çº²

### ä¸€ã€[ä¸»é¢˜ä¸€]
- 1.1 [å­ä¸»é¢˜]
  - è¦ç‚¹è¯´æ˜
- 1.2 [å­ä¸»é¢˜]

### äºŒã€[ä¸»é¢˜äºŒ]
...

---
ä»¥ä¸‹æ˜¯å‚è€ƒèµ„æ–™ï¼š
{context}`
```

#### æµ‹éªŒ Prompt
```typescript
const QUIZ_PROMPT = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ•™è‚²æµ‹éªŒè®¾è®¡å¸ˆã€‚è¯·åŸºäºä»¥ä¸‹èµ„æ–™ç”Ÿæˆ 5-10 é“é€‰æ‹©é¢˜ã€‚

è¦æ±‚ï¼š
1. é¢˜ç›®è¦†ç›–èµ„æ–™çš„ä¸»è¦çŸ¥è¯†ç‚¹
2. æ¯é¢˜ 4 ä¸ªé€‰é¡¹ï¼ˆA/B/C/Dï¼‰
3. éš¾åº¦é€‚ä¸­ï¼Œè€ƒå¯Ÿç†è§£è€Œéè®°å¿†
4. æä¾›è¯¦ç»†è§£æ

è¾“å‡ºæ ¼å¼ï¼ˆä¸¥æ ¼ JSONï¼Œä¸è¦æœ‰å…¶ä»–å†…å®¹ï¼‰ï¼š
{
  "title": "çŸ¥è¯†æµ‹éªŒ",
  "questions": [
    {
      "id": "q1",
      "question": "é—®é¢˜å†…å®¹ï¼Ÿ",
      "options": ["A. é€‰é¡¹ä¸€", "B. é€‰é¡¹äºŒ", "C. é€‰é¡¹ä¸‰", "D. é€‰é¡¹å››"],
      "answer": "A",
      "explanation": "è§£æï¼šæ­£ç¡®ç­”æ¡ˆæ˜¯ Aï¼Œå› ä¸º..."
    }
  ]
}

---
ä»¥ä¸‹æ˜¯å‚è€ƒèµ„æ–™ï¼š
{context}`
```

#### æ€ç»´å¯¼å›¾ Prompt
```typescript
const MINDMAP_PROMPT = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„çŸ¥è¯†å¯è§†åŒ–åŠ©æ‰‹ã€‚è¯·åŸºäºä»¥ä¸‹èµ„æ–™ç”Ÿæˆä¸€ä»½æ€ç»´å¯¼å›¾ç»“æ„ã€‚

è¦æ±‚ï¼š
1. æå–æ ¸å¿ƒæ¦‚å¿µä½œä¸ºæ ¹èŠ‚ç‚¹
2. æŒ‰é€»è¾‘å…³ç³»ç»„ç»‡å­èŠ‚ç‚¹ï¼ˆæœ€å¤š 4 çº§ï¼‰
3. æ¯ä¸ªèŠ‚ç‚¹æ ‡ç­¾ç®€æ´ï¼ˆä¸è¶…è¿‡ 15 å­—ï¼‰
4. å¯é€‰æ·»åŠ èŠ‚ç‚¹æè¿°ï¼ˆè¯¦ç»†è¯´æ˜ï¼‰
5. æ¯ä¸ªçˆ¶èŠ‚ç‚¹ä¸‹æœ€å¤š 6 ä¸ªå­èŠ‚ç‚¹

è¾“å‡ºæ ¼å¼ï¼ˆä¸¥æ ¼ JSONï¼Œä¸è¦æœ‰å…¶ä»–å†…å®¹ï¼‰ï¼š
{
  "title": "çŸ¥è¯†ç»“æ„å›¾",
  "root": {
    "id": "root",
    "label": "æ ¸å¿ƒä¸»é¢˜",
    "description": "ä¸»é¢˜çš„è¯¦ç»†è¯´æ˜",
    "children": [
      {
        "id": "1",
        "label": "åˆ†æ”¯ä¸€",
        "description": "åˆ†æ”¯è¯´æ˜",
        "children": [
          { "id": "1-1", "label": "å­èŠ‚ç‚¹", "description": "è¯´æ˜" }
        ]
      }
    ]
  }
}

---
ä»¥ä¸‹æ˜¯å‚è€ƒèµ„æ–™ï¼š
{context}`
```

### å†…å®¹è·å–ç­–ç•¥ï¼ˆæ™ºèƒ½é‡‡æ ·ï¼‰
```typescript
/**
 * æ™ºèƒ½å†…å®¹é‡‡æ · - è§„é¿ Token é™åˆ¶é£é™©
 * ç­–ç•¥ï¼šä¼˜å…ˆé‡‡æ ·æ¯ä¸ª Source çš„å¼€å¤´å’Œç»“å°¾ chunksï¼Œç¡®ä¿è¦†ç›–å…¨é¢
 */
async function getSourceContentSmart(notebookId: string, sourceIds?: string[]) {
  // 1. è·å–æ‰€æœ‰ ready çŠ¶æ€çš„ Sources
  const sources = await prisma.source.findMany({
    where: {
      notebookId,
      status: 'ready',
      ...(sourceIds ? { id: { in: sourceIds } } : {}),
    },
    select: { id: true, title: true },
  })

  if (sources.length === 0) {
    throw new Error('NO_SOURCES')
  }

  // 2. æ¯ä¸ª Source é‡‡æ ·ç­–ç•¥ï¼šå¼€å¤´ 3 ä¸ª + ç»“å°¾ 2 ä¸ª chunks
  const CHUNKS_PER_SOURCE_HEAD = 3
  const CHUNKS_PER_SOURCE_TAIL = 2
  const MAX_TOTAL_CHUNKS = 40

  const allChunks: Array<{ content: string; sourceTitle: string }> = []

  for (const source of sources) {
    // è·å–è¯¥ Source çš„ chunk æ€»æ•°
    const countResult = await prisma.$queryRaw<[{ count: bigint }]>`
      SELECT COUNT(*) as count FROM document_chunks 
      WHERE source_id = ${source.id}::uuid
    `
    const totalChunks = Number(countResult[0].count)

    // è·å–å¼€å¤´ chunks
    const headChunks = await prisma.$queryRaw<Array<{ content: string }>>`
      SELECT content FROM document_chunks
      WHERE source_id = ${source.id}::uuid
      ORDER BY chunk_index ASC
      LIMIT ${CHUNKS_PER_SOURCE_HEAD}
    `

    // è·å–ç»“å°¾ chunksï¼ˆå¦‚æœæ€»æ•°è¶³å¤Ÿï¼‰
    let tailChunks: Array<{ content: string }> = []
    if (totalChunks > CHUNKS_PER_SOURCE_HEAD + CHUNKS_PER_SOURCE_TAIL) {
      tailChunks = await prisma.$queryRaw<Array<{ content: string }>>`
        SELECT content FROM document_chunks
        WHERE source_id = ${source.id}::uuid
        ORDER BY chunk_index DESC
        LIMIT ${CHUNKS_PER_SOURCE_TAIL}
      `
      tailChunks.reverse()
    }

    // åˆå¹¶
    for (const c of headChunks) {
      allChunks.push({ content: c.content, sourceTitle: source.title })
    }
    for (const c of tailChunks) {
      allChunks.push({ content: c.content, sourceTitle: source.title })
    }

    // æ£€æŸ¥æ˜¯å¦è¶…å‡ºæ€»é™åˆ¶
    if (allChunks.length >= MAX_TOTAL_CHUNKS) break
  }

  // 3. ç»„è£…ä¸Šä¸‹æ–‡
  return allChunks.slice(0, MAX_TOTAL_CHUNKS).map((c, i) =>
    `### æ¥æº ${i + 1}: ${c.sourceTitle}\n${c.content}`
  ).join('\n\n---\n\n')
}
```

### Token é™åˆ¶å¤„ç†ï¼ˆå¢å¼ºç‰ˆï¼‰
```typescript
// ä¼°ç®— token æ•°ï¼ˆä¸­æ–‡çº¦ 1.5-2 å­—ç¬¦/tokenï¼Œè‹±æ–‡çº¦ 4 å­—ç¬¦/tokenï¼‰
function estimateTokens(text: string): number {
  const chineseChars = (text.match(/[\u4e00-\u9fa5]/g) || []).length
  const otherChars = text.length - chineseChars
  return Math.ceil(chineseChars / 1.5 + otherChars / 4)
}

// æœ€å¤§ä¸Šä¸‹æ–‡ token æ•°ï¼ˆä¸ºè¾“å‡ºé¢„ç•™ç©ºé—´ï¼‰
const MAX_CONTEXT_TOKENS = 5000
const MAX_OUTPUT_TOKENS = 2000

// æ™ºèƒ½æˆªæ–­ï¼šä¿ç•™å®Œæ•´çš„ Source å—
function truncateContextSmart(context: string): string {
  const tokens = estimateTokens(context)
  if (tokens <= MAX_CONTEXT_TOKENS) return context

  // æŒ‰ Source å—åˆ†å‰²
  const blocks = context.split('\n\n---\n\n')
  let result = ''
  let currentTokens = 0

  for (const block of blocks) {
    const blockTokens = estimateTokens(block)
    if (currentTokens + blockTokens > MAX_CONTEXT_TOKENS) {
      break
    }
    result += (result ? '\n\n---\n\n' : '') + block
    currentTokens += blockTokens
  }

  return result + '\n\n[éƒ¨åˆ†å†…å®¹å·²çœç•¥ï¼ŒåŸºäºä»¥ä¸Šå†…å®¹ç”Ÿæˆ]'
}
```

### JSON è§£æå®¹é”™å¤„ç†
```typescript
/**
 * å®‰å…¨è§£æ JSON - è§„é¿ JSON è§£æé£é™©
 * å¤„ç† LLM å¯èƒ½è¿”å›çš„å„ç§æ ¼å¼é—®é¢˜
 */
function safeParseJSON<T>(text: string, fallback: T): T {
  try {
    // 1. å°è¯•ç›´æ¥è§£æ
    return JSON.parse(text)
  } catch {
    try {
      // 2. å°è¯•æå– JSON å—ï¼ˆå¤„ç† markdown ä»£ç å—åŒ…è£¹ï¼‰
      const jsonMatch = text.match(/```(?:json)?\s*([\s\S]*?)```/)
      if (jsonMatch) {
        return JSON.parse(jsonMatch[1].trim())
      }

      // 3. å°è¯•æå– { } æˆ– [ ] åŒ…è£¹çš„å†…å®¹
      const objectMatch = text.match(/\{[\s\S]*\}/)
      const arrayMatch = text.match(/\[[\s\S]*\]/)
      const match = objectMatch || arrayMatch
      if (match) {
        return JSON.parse(match[0])
      }
    } catch {
      // è§£æå¤±è´¥
    }

    console.error('[JSON Parse] è§£æå¤±è´¥ï¼Œä½¿ç”¨ fallback:', text.slice(0, 200))
    return fallback
  }
}

// æµ‹éªŒ fallback
const QUIZ_FALLBACK: Quiz = {
  title: 'çŸ¥è¯†æµ‹éªŒ',
  questions: [{
    id: 'q1',
    question: 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•',
    options: ['A. é‡è¯•', 'B. é‡è¯•', 'C. é‡è¯•', 'D. é‡è¯•'],
    answer: 'A',
    explanation: 'è¯·ç‚¹å‡»é‡æ–°ç”Ÿæˆ'
  }]
}

// æ€ç»´å¯¼å›¾ fallback
const MINDMAP_FALLBACK: MindMap = {
  title: 'çŸ¥è¯†ç»“æ„',
  root: {
    id: 'root',
    label: 'ç”Ÿæˆå¤±è´¥',
    description: 'è¯·é‡è¯•',
    children: []
  }
}
```

### ç”Ÿæˆè¶…æ—¶å¤„ç†
```typescript
/**
 * å¸¦è¶…æ—¶çš„ LLM è°ƒç”¨ - è§„é¿ç”Ÿæˆæ—¶é—´é£é™©
 */
async function generateWithTimeout(
  prompt: string,
  timeoutMs: number = 60000
): Promise<string> {
  const controller = new AbortController()
  const timeoutId = setTimeout(() => controller.abort(), timeoutMs)

  try {
    const response = await fetch(`${zhipuConfig.baseUrl}/paas/v4/chat/completions`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${zhipuConfig.apiKey}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: zhipuConfig.chatModel,
        messages: [{ role: 'user', content: prompt }],
        max_tokens: MAX_OUTPUT_TOKENS,
      }),
      signal: controller.signal,
    })

    clearTimeout(timeoutId)

    if (!response.ok) {
      throw new Error(`API é”™è¯¯: ${response.status}`)
    }

    const data = await response.json()
    return data.choices[0]?.message?.content || ''
  } catch (error) {
    clearTimeout(timeoutId)
    if ((error as Error).name === 'AbortError') {
      throw new Error('TIMEOUT')
    }
    throw error
  }
}
```

### æ€ç»´å¯¼å›¾æ¸²æŸ“æ–¹æ¡ˆ

#### æ–¹æ¡ˆé€‰å‹ï¼šReact Flow
```typescript
// ä½¿ç”¨ @xyflow/reactï¼ˆåŸ react-flowï¼‰æ¸²æŸ“æ€ç»´å¯¼å›¾
// ä¼˜ç‚¹ï¼šè½»é‡ã€å¯å®šåˆ¶ã€æ”¯æŒç¼©æ”¾æ‹–æ‹½ã€ç¤¾åŒºæ´»è·ƒ

// å®‰è£…ä¾èµ–
// npm install @xyflow/react

// æ•°æ®è½¬æ¢ï¼šMindMap JSON â†’ React Flow Nodes/Edges
function mindmapToFlow(mindmap: MindMap): { nodes: Node[]; edges: Edge[] } {
  const nodes: Node[] = []
  const edges: Edge[] = []
  
  function traverse(node: MindMapNode, level: number, parentId?: string, index: number = 0) {
    const nodeId = node.id
    
    // è®¡ç®—ä½ç½®ï¼ˆç®€å•çš„æ ‘å½¢å¸ƒå±€ï¼‰
    const x = level * 250
    const y = index * 80
    
    nodes.push({
      id: nodeId,
      type: 'mindmapNode',
      position: { x, y },
      data: { 
        label: node.label, 
        description: node.description,
        level 
      },
    })
    
    if (parentId) {
      edges.push({
        id: `${parentId}-${nodeId}`,
        source: parentId,
        target: nodeId,
        type: 'smoothstep',
      })
    }
    
    node.children?.forEach((child, i) => {
      traverse(child, level + 1, nodeId, i)
    })
  }
  
  traverse(mindmap.root, 0)
  return { nodes, edges }
}
```

#### è‡ªå®šä¹‰èŠ‚ç‚¹æ ·å¼
```tsx
// components/notebook/mindmap-node.tsx
const MindMapNode = ({ data }: { data: { label: string; description?: string; level: number } }) => {
  const bgColors = ['bg-blue-500', 'bg-green-500', 'bg-purple-500', 'bg-orange-500']
  const bgColor = bgColors[data.level % bgColors.length]
  
  return (
    <Tooltip title={data.description}>
      <div className={`px-4 py-2 rounded-lg ${bgColor} text-white shadow-md 
        ${data.level === 0 ? 'text-lg font-bold' : 'text-sm'}`}>
        {data.label}
      </div>
    </Tooltip>
  )
}
```

#### å¯¼å‡º PNG åŠŸèƒ½
```typescript
import { toPng } from 'html-to-image'

async function exportMindmapToPng(elementId: string, filename: string) {
  const element = document.getElementById(elementId)
  if (!element) return
  
  const dataUrl = await toPng(element, {
    backgroundColor: '#ffffff',
    pixelRatio: 2,
  })
  
  const link = document.createElement('a')
  link.download = `${filename}.png`
  link.href = dataUrl
  link.click()
}
```

## API ç«¯ç‚¹

### POST /api/studio/generate
ç”Ÿæˆäº§ç‰©ï¼ˆç»Ÿä¸€å…¥å£ï¼‰

**Request:**
```typescript
{
  notebookId: string
  type: 'summary' | 'outline' | 'quiz' | 'mindmap'
  sourceIds?: string[]  // å¯é€‰ï¼ŒæŒ‡å®š Sources
  mode: 'fast' | 'precise'  // ç”Ÿæˆæ¨¡å¼ï¼šå¿«é€Ÿ/ç²¾å‡†
}
```

**Response:**
```typescript
{
  artifact: {
    id: string
    type: string
    content: string  // Markdown æˆ– JSON å­—ç¬¦ä¸²
    createdAt: string
  }
  stats: {
    mode: 'fast' | 'precise'
    strategy: string  // 'smart_sampling' | 'map_reduce'
    totalChunks: number
    usedChunks: number
    duration: number  // è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
  }
}
```

**Error Response:**
```typescript
{
  error: string
  code: 'NO_SOURCES' | 'GENERATION_FAILED' | 'TIMEOUT' | 'PARSE_ERROR'
}
```

### GET /api/notebooks/:id/artifacts
è·å–äº§ç‰©åˆ—è¡¨

### DELETE /api/artifacts/:id
åˆ é™¤äº§ç‰©

## UI ç»„ä»¶ç»“æ„

```
components/notebook/
â”œâ”€â”€ studio-panel.tsx           # Studio é¢æ¿ä¸»ç»„ä»¶ï¼ˆå«æ¨¡å¼é€‰æ‹©ä¸‹æ‹‰æ¡†ï¼‰
â”œâ”€â”€ studio-mode-select.tsx     # æ¨¡å¼é€‰æ‹©ä¸‹æ‹‰æ¡†ç»„ä»¶
â”œâ”€â”€ studio-actions.tsx         # åŠ¨ä½œæŒ‰é’®ç»„
â”œâ”€â”€ artifact-list.tsx          # äº§ç‰©åˆ—è¡¨
â”œâ”€â”€ artifact-card.tsx          # äº§ç‰©å¡ç‰‡ï¼ˆå¯å±•å¼€ï¼‰
â”œâ”€â”€ quiz-viewer.tsx            # æµ‹éªŒäº¤äº’ç»„ä»¶
â”œâ”€â”€ mindmap-viewer.tsx         # æ€ç»´å¯¼å›¾ç»„ä»¶
â”œâ”€â”€ mindmap-node.tsx           # æ€ç»´å¯¼å›¾è‡ªå®šä¹‰èŠ‚ç‚¹
â””â”€â”€ markdown-viewer.tsx        # Markdown æ¸²æŸ“ï¼ˆå¤ç”¨ XMarkdownï¼‰
```

### Studio é¢æ¿å¤´éƒ¨å¸ƒå±€
```tsx
// Studio æ ‡é¢˜æ å¸ƒå±€ç¤ºæ„
<div className="flex items-center justify-between">
  <h3 className="font-semibold">Studio</h3>
  <StudioModeSelect value={mode} onChange={setMode} />
</div>
```

### æ¨¡å¼é€‰æ‹©ç»„ä»¶
```tsx
// components/notebook/studio-mode-select.tsx
import { Select, Tooltip } from 'antd'
import { Zap, Target } from 'lucide-react'

type StudioMode = 'fast' | 'precise'

interface StudioModeSelectProps {
  value: StudioMode
  onChange: (mode: StudioMode) => void
}

export function StudioModeSelect({ value, onChange }: StudioModeSelectProps) {
  return (
    <Tooltip 
      title={
        <div className="text-xs">
          <p><strong>âš¡ å¿«é€Ÿæ¨¡å¼</strong>ï¼šæ™ºèƒ½é‡‡æ ·ï¼Œ5-15ç§’</p>
          <p><strong>ğŸ¯ ç²¾å‡†æ¨¡å¼</strong>ï¼šMap-Reduceï¼Œ30-90ç§’</p>
        </div>
      }
    >
      <Select
        value={value}
        onChange={onChange}
        size="small"
        style={{ width: 120 }}
        options={[
          { 
            value: 'fast', 
            label: (
              <span className="flex items-center gap-1">
                <Zap className="h-3 w-3" /> å¿«é€Ÿæ¨¡å¼
              </span>
            )
          },
          { 
            value: 'precise', 
            label: (
              <span className="flex items-center gap-1">
                <Target className="h-3 w-3" /> ç²¾å‡†æ¨¡å¼
              </span>
            )
          },
        ]}
      />
    </Tooltip>
  )
}
```

## ä¾èµ–
- US-005 (æ–‡æ¡£å‘é‡åŒ–) - éœ€è¦ `document_chunks` è¡¨æ•°æ®
- US-006 (RAG é—®ç­”) - å¤ç”¨ LLM è°ƒç”¨é€»è¾‘
- `artifacts` è¡¨å·²åœ¨ Prisma schema ä¸­å®šä¹‰
- æ™ºè°± API Key å·²é…ç½®
- æ–°å¢ä¾èµ–ï¼š`@xyflow/react`ï¼ˆæ€ç»´å¯¼å›¾ï¼‰ã€`html-to-image`ï¼ˆå¯¼å‡º PNGï¼‰

## ä¼˜å…ˆçº§
P1 - Week 5

## ä¼°ç®—
10 Story Points (5å¤©)

## å®ç°è®¡åˆ’

### Day 1: API å±‚
- [ ] åˆ›å»º `lib/studio/prompts.ts` - Prompt æ¨¡æ¿
- [ ] åˆ›å»º `lib/studio/content.ts` - æ™ºèƒ½å†…å®¹é‡‡æ ·
- [ ] åˆ›å»º `lib/studio/generator.ts` - å†…å®¹ç”Ÿæˆé€»è¾‘ï¼ˆå«è¶…æ—¶å’Œå®¹é”™ï¼‰
- [ ] å®ç° `POST /api/studio/generate` API
- [ ] å®ç° `GET /api/notebooks/:id/artifacts` API
- [ ] å®ç° `DELETE /api/artifacts/:id` API

### Day 2: UI ç»„ä»¶ - åŸºç¡€
- [ ] å®‰è£…ä¾èµ–ï¼š`@xyflow/react`, `html-to-image`
- [ ] åˆ›å»º `StudioPanel` ç»„ä»¶æ›¿æ¢ç°æœ‰å ä½
- [ ] åˆ›å»º `StudioActions` åŠ¨ä½œæŒ‰é’®ç»„
- [ ] åˆ›å»º `ArtifactList` äº§ç‰©åˆ—è¡¨
- [ ] åˆ›å»º `ArtifactCard` äº§ç‰©å¡ç‰‡

### Day 3: UI ç»„ä»¶ - æ‘˜è¦/å¤§çº²/æµ‹éªŒ
- [ ] å®ç°æ‘˜è¦/å¤§çº²çš„ Markdown æ¸²æŸ“ï¼ˆå¤ç”¨ XMarkdownï¼‰
- [ ] åˆ›å»º `QuizViewer` æµ‹éªŒäº¤äº’ç»„ä»¶
- [ ] å®ç°å¤åˆ¶åˆ°å‰ªè´´æ¿åŠŸèƒ½
- [ ] å®ç°åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†

### Day 4: UI ç»„ä»¶ - æ€ç»´å¯¼å›¾
- [ ] åˆ›å»º `MindMapViewer` ç»„ä»¶
- [ ] åˆ›å»º `MindMapNode` è‡ªå®šä¹‰èŠ‚ç‚¹
- [ ] å®ç°ç¼©æ”¾ã€æ‹–æ‹½ã€å±•å¼€/æ”¶èµ·
- [ ] å®ç°å¯¼å‡º PNG åŠŸèƒ½

### Day 5: é›†æˆå’Œæµ‹è¯•
- [ ] é›†æˆåˆ° `NotebookContent`
- [ ] åŠ è½½çŠ¶æ€å’Œé”™è¯¯å¤„ç†
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•
- [ ] æ€§èƒ½ä¼˜åŒ–ï¼ˆé˜²æŠ–ã€ç¼“å­˜ï¼‰

## æµ‹è¯•ç”¨ä¾‹
1. ä¸Šä¼  AI æ–‡æ¡£ï¼Œç‚¹å‡»"ç”Ÿæˆæ‘˜è¦" â†’ ç”Ÿæˆç»“æ„åŒ–æ‘˜è¦ï¼ŒMarkdown æ­£ç¡®æ¸²æŸ“
2. ç‚¹å‡»"ç”Ÿæˆå¤§çº²" â†’ ç”Ÿæˆå±‚çº§å¤§çº²
3. ç‚¹å‡»"ç”Ÿæˆæµ‹éªŒ" â†’ ç”Ÿæˆ 5-10 é“é¢˜ç›®ï¼Œå¯äº¤äº’ç­”é¢˜ï¼Œæ˜¾ç¤ºå¾—åˆ†
4. ç‚¹å‡»"ç”Ÿæˆæ€ç»´å¯¼å›¾" â†’ ç”Ÿæˆå¯è§†åŒ–ç»“æ„å›¾ï¼Œæ”¯æŒç¼©æ”¾æ‹–æ‹½
5. å¯¼å‡ºæ€ç»´å¯¼å›¾ â†’ ä¸‹è½½ PNG å›¾ç‰‡
6. å¤åˆ¶äº§ç‰©å†…å®¹ â†’ å‰ªè´´æ¿åŒ…å«å®Œæ•´å†…å®¹
7. åˆ é™¤äº§ç‰© â†’ ç¡®è®¤åä»åˆ—è¡¨æ¶ˆå¤±
8. åˆ·æ–°é¡µé¢ â†’ äº§ç‰©åˆ—è¡¨ä¿ç•™
9. æ—  ready Sources â†’ æŒ‰é’®ç¦ç”¨ï¼Œæ˜¾ç¤ºæç¤º
10. ç”Ÿæˆè¶…æ—¶ â†’ æ˜¾ç¤ºè¶…æ—¶æç¤ºï¼Œæ”¯æŒé‡è¯•
11. JSON è§£æå¤±è´¥ â†’ æ˜¾ç¤º fallback å†…å®¹ï¼Œæç¤ºé‡è¯•
12. åˆ‡æ¢åˆ°ç²¾å‡†æ¨¡å¼ â†’ ä¸‹æ‹‰æ¡†æ˜¾ç¤º"ğŸ¯ ç²¾å‡†æ¨¡å¼"
13. ç²¾å‡†æ¨¡å¼ç”Ÿæˆæ‘˜è¦ â†’ ä½¿ç”¨ Map-Reduceï¼Œè€—æ—¶æ›´é•¿ä½†è¦†ç›–æ›´å…¨
14. å¿«é€Ÿæ¨¡å¼ç”Ÿæˆæ‘˜è¦ â†’ ä½¿ç”¨æ™ºèƒ½é‡‡æ ·ï¼Œé€Ÿåº¦æ›´å¿«
15. åˆ·æ–°é¡µé¢ â†’ æ¨¡å¼é€‰æ‹©ä¿ç•™ï¼ˆlocalStorageï¼‰
16. æŸ¥çœ‹ç”Ÿæˆç»Ÿè®¡ â†’ æ˜¾ç¤ºä½¿ç”¨çš„ç­–ç•¥ã€chunks æ•°é‡å’Œè€—æ—¶

## æ¶æ„é£é™©åŠè§„é¿æ–¹æ¡ˆ

### é£é™© 1ï¼šToken é™åˆ¶ï¼ˆå¤§é‡ Sources æ—¶è¶…å‡ºä¸Šä¸‹æ–‡é™åˆ¶ï¼‰
**è§„é¿æ–¹æ¡ˆï¼šæ™ºèƒ½é‡‡æ ·**
- æ¯ä¸ª Source åªé‡‡æ ·å¼€å¤´ 3 ä¸ª + ç»“å°¾ 2 ä¸ª chunks
- æ€» chunks æ•°é™åˆ¶åœ¨ 40 ä¸ªä»¥å†…
- æ™ºèƒ½æˆªæ–­ä¿ç•™å®Œæ•´çš„ Source å—
- ä¸ºè¾“å‡ºé¢„ç•™ 2000 tokens ç©ºé—´

### é£é™© 2ï¼šç”Ÿæˆæ—¶é—´è¿‡é•¿ï¼ˆå¤æ‚å†…å®¹å¯èƒ½éœ€è¦ 30-60 ç§’ï¼‰
**è§„é¿æ–¹æ¡ˆï¼šè¶…æ—¶æ§åˆ¶ + ç”¨æˆ·åé¦ˆ**
- è®¾ç½® 60 ç§’è¶…æ—¶é™åˆ¶
- ä½¿ç”¨ AbortController ä¸­æ–­è¯·æ±‚
- æ˜¾ç¤ºè¿›åº¦æç¤ºï¼ˆ"æ­£åœ¨ç”Ÿæˆï¼Œé¢„è®¡éœ€è¦ 30 ç§’..."ï¼‰
- è¶…æ—¶åæä¾›é‡è¯•æŒ‰é’®

### é£é™© 3ï¼šJSON è§£æå¤±è´¥ï¼ˆLLM è¿”å›éæ³• JSONï¼‰
**è§„é¿æ–¹æ¡ˆï¼šå¤šå±‚å®¹é”™è§£æ**
- ç¬¬ä¸€å±‚ï¼šç›´æ¥ JSON.parse
- ç¬¬äºŒå±‚ï¼šæå– markdown ä»£ç å—ä¸­çš„ JSON
- ç¬¬ä¸‰å±‚ï¼šæ­£åˆ™æå– {} æˆ– [] åŒ…è£¹çš„å†…å®¹
- æœ€ç»ˆï¼šä½¿ç”¨é¢„å®šä¹‰çš„ fallback æ•°æ®
- è®°å½•è§£æå¤±è´¥æ—¥å¿—ï¼Œä¾¿äºä¼˜åŒ– Prompt

### é£é™© 4ï¼šæ€ç»´å¯¼å›¾å¸ƒå±€æ··ä¹±ï¼ˆèŠ‚ç‚¹è¿‡å¤šæˆ–å±‚çº§è¿‡æ·±ï¼‰
**è§„é¿æ–¹æ¡ˆï¼šé™åˆ¶ + è‡ªåŠ¨å¸ƒå±€**
- Prompt ä¸­é™åˆ¶æœ€å¤š 4 çº§ã€æ¯çº§æœ€å¤š 6 ä¸ªå­èŠ‚ç‚¹
- ä½¿ç”¨ dagre ç®—æ³•è‡ªåŠ¨è®¡ç®—å¸ƒå±€
- æ”¯æŒèŠ‚ç‚¹å±•å¼€/æ”¶èµ·ï¼Œé»˜è®¤åªå±•å¼€å‰ 2 çº§
- æä¾›"é‡ç½®è§†å›¾"æŒ‰é’®

### é£é™© 5ï¼šå¹¶å‘ç”Ÿæˆå¯¼è‡´èµ„æºç«äº‰
**è§„é¿æ–¹æ¡ˆï¼šå‰ç«¯é˜²æŠ– + çŠ¶æ€é”**
- ç”Ÿæˆä¸­ç¦ç”¨æ‰€æœ‰åŠ¨ä½œæŒ‰é’®
- ä½¿ç”¨ loading çŠ¶æ€é˜²æ­¢é‡å¤ç‚¹å‡»
- åç«¯å¯é€‰ï¼šä½¿ç”¨é˜Ÿåˆ—é™åˆ¶å¹¶å‘æ•°

## æ–‡ä»¶æ¸…å•ï¼ˆé¢„è®¡æ–°å¢ï¼‰

```
lib/studio/
â”œâ”€â”€ index.ts              # æ¨¡å—å¯¼å‡º
â”œâ”€â”€ prompts.ts            # Prompt æ¨¡æ¿ï¼ˆ4 ç§ç±»å‹ï¼‰
â”œâ”€â”€ content.ts            # æ™ºèƒ½å†…å®¹é‡‡æ · + Map-Reduce
â”œâ”€â”€ generator.ts          # å†…å®¹ç”Ÿæˆï¼ˆå«è¶…æ—¶å’Œå®¹é”™ï¼‰
â””â”€â”€ parser.ts             # JSON å®‰å…¨è§£æ

app/api/
â”œâ”€â”€ studio/generate/route.ts           # ç”Ÿæˆäº§ç‰© API
â”œâ”€â”€ notebooks/[id]/artifacts/route.ts  # è·å–äº§ç‰©åˆ—è¡¨
â””â”€â”€ artifacts/[id]/route.ts            # åˆ é™¤äº§ç‰©

components/notebook/
â”œâ”€â”€ studio-panel.tsx       # Studio é¢æ¿ï¼ˆå«æ¨¡å¼é€‰æ‹©ï¼‰
â”œâ”€â”€ studio-mode-select.tsx # æ¨¡å¼é€‰æ‹©ä¸‹æ‹‰æ¡†
â”œâ”€â”€ studio-actions.tsx     # åŠ¨ä½œæŒ‰é’®
â”œâ”€â”€ artifact-list.tsx      # äº§ç‰©åˆ—è¡¨
â”œâ”€â”€ artifact-card.tsx      # äº§ç‰©å¡ç‰‡
â”œâ”€â”€ quiz-viewer.tsx        # æµ‹éªŒç»„ä»¶
â”œâ”€â”€ mindmap-viewer.tsx     # æ€ç»´å¯¼å›¾ç»„ä»¶
â””â”€â”€ mindmap-node.tsx       # æ€ç»´å¯¼å›¾èŠ‚ç‚¹

hooks/
â””â”€â”€ use-studio-mode.ts     # æ¨¡å¼çŠ¶æ€ç®¡ç†ï¼ˆlocalStorage æŒä¹…åŒ–ï¼‰
```


---

## æ–‡æ¡£è¯„ä¼°ä¸è¡¥å……

### å‘ç°çš„æ¼æ´å’Œé—æ¼

#### 1. äº§ç‰©ç¼–è¾‘åŠŸèƒ½ç¼ºå¤±
- [ ] ç”¨æˆ·å¯èƒ½éœ€è¦ç¼–è¾‘ç”Ÿæˆçš„äº§ç‰©ï¼ˆä¿®æ­£é”™è¯¯ã€è¡¥å……å†…å®¹ï¼‰
- **è¡¥å……æ–¹æ¡ˆ**ï¼šäºŒæœŸæ”¯æŒäº§ç‰©ç¼–è¾‘ï¼Œä¿å­˜ç¼–è¾‘å†å²

#### 2. äº§ç‰©é‡æ–°ç”Ÿæˆ
- [ ] å¯¹åŒä¸€å†…å®¹é‡æ–°ç”Ÿæˆæ—¶ï¼Œæ˜¯å¦è¦†ç›–è¿˜æ˜¯æ–°å»ºï¼Ÿ
- **è¡¥å……æ–¹æ¡ˆ**ï¼šæ¯æ¬¡ç”Ÿæˆéƒ½åˆ›å»ºæ–°äº§ç‰©ï¼Œç”¨æˆ·å¯åˆ é™¤æ—§çš„

#### 3. äº§ç‰©æ•°é‡é™åˆ¶
- [ ] å•ä¸ª Notebook çš„äº§ç‰©æ•°é‡æ˜¯å¦æœ‰ä¸Šé™ï¼Ÿ
- **è¡¥å……æ–¹æ¡ˆ**ï¼šé™åˆ¶æ¯ä¸ª Notebook æœ€å¤š 10 ä¸ªäº§ç‰©ï¼Œè¶…å‡ºæç¤ºåˆ é™¤æ—§äº§ç‰©

#### 4. æµ‹éªŒçŠ¶æ€æŒä¹…åŒ–
- [ ] ç”¨æˆ·ç­”é¢˜è¿›åº¦æ˜¯å¦ä¿å­˜ï¼Ÿåˆ·æ–°åæ˜¯å¦ä¿ç•™ï¼Ÿ
- **è¡¥å……æ–¹æ¡ˆ**ï¼šç­”é¢˜çŠ¶æ€ä»…ä¿å­˜åœ¨å‰ç«¯ localStorageï¼Œåˆ·æ–°åå¯æ¢å¤

#### 5. æ€ç»´å¯¼å›¾ç¼–è¾‘
- [ ] ç”¨æˆ·æ˜¯å¦å¯ä»¥æ‰‹åŠ¨è°ƒæ•´èŠ‚ç‚¹ä½ç½®ï¼Ÿ
- **è¡¥å……æ–¹æ¡ˆ**ï¼šä¸€æœŸåªæ”¯æŒæŸ¥çœ‹ï¼ŒäºŒæœŸæ”¯æŒæ‹–æ‹½ç¼–è¾‘èŠ‚ç‚¹

#### 6. å¤šè¯­è¨€æ”¯æŒ
- [ ] Prompt æ˜¯å¦éœ€è¦æ”¯æŒè‹±æ–‡èµ„æ–™ï¼Ÿ
- **è¡¥å……æ–¹æ¡ˆ**ï¼šPrompt ä¸­æ·»åŠ "æ ¹æ®èµ„æ–™è¯­è¨€è‡ªåŠ¨é€‰æ‹©è¾“å‡ºè¯­è¨€"

#### 7. äº§ç‰©åˆ†äº«åŠŸèƒ½
- [ ] ç”¨æˆ·æ˜¯å¦å¯ä»¥åˆ†äº«äº§ç‰©ç»™ä»–äººï¼Ÿ
- **è¡¥å……æ–¹æ¡ˆ**ï¼šäºŒæœŸæ”¯æŒç”Ÿæˆåˆ†äº«é“¾æ¥ï¼ˆåªè¯»ï¼‰

#### 8. API æƒé™æ ¡éªŒé—æ¼
- [ ] åˆ é™¤äº§ç‰©æ—¶éœ€è¦æ ¡éªŒæ˜¯å¦å±äºå½“å‰ç”¨æˆ·
- **è¡¥å……æ–¹æ¡ˆ**ï¼šAPI ä¸­æ·»åŠ  notebook.ownerId === userId æ ¡éªŒ

#### 9. äº§ç‰©æ ‡é¢˜è‡ªå®šä¹‰
- [ ] ç”¨æˆ·å¯èƒ½æƒ³ç»™äº§ç‰©èµ·ä¸€ä¸ªæœ‰æ„ä¹‰çš„åå­—
- **è¡¥å……æ–¹æ¡ˆ**ï¼šæ”¯æŒç‚¹å‡»æ ‡é¢˜ç¼–è¾‘ï¼Œé»˜è®¤ä¸º"æ‘˜è¦ #1"æ ¼å¼

#### 10. ç”Ÿæˆè¿›åº¦åé¦ˆ
- [ ] é•¿æ—¶é—´ç”Ÿæˆæ—¶ç”¨æˆ·ä¸çŸ¥é“è¿›åº¦
- **è¡¥å……æ–¹æ¡ˆ**ï¼šæ˜¾ç¤ºé¢„ä¼°æ—¶é—´å’Œå·²ç”¨æ—¶é—´

---

## Token é™åˆ¶çš„æ›´ä¼˜æ–¹æ¡ˆ

### æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| **æ™ºèƒ½é‡‡æ ·** | ç®€å•ã€å¿«é€Ÿ | å¯èƒ½ä¸¢å¤±ä¸­é—´é‡è¦å†…å®¹ | å†…å®¹ç»“æ„æ¸…æ™°çš„æ–‡æ¡£ |
| **Map-Reduce** | è¦†ç›–å…¨é¢ã€è´¨é‡é«˜ | å¤šæ¬¡ API è°ƒç”¨ã€è€—æ—¶é•¿ã€æˆæœ¬é«˜ | å¤§å‹æ–‡æ¡£ã€é«˜è´¨é‡è¦æ±‚ |
| **è¯­ä¹‰èšç±»é‡‡æ ·** | è¦†ç›–å¤šæ ·æ€§å¥½ | å®ç°å¤æ‚ã€éœ€è¦é¢å¤–è®¡ç®— | å†…å®¹ä¸»é¢˜åˆ†æ•£çš„æ–‡æ¡£ |
| **æ‘˜è¦é“¾** | ä¿ç•™å…¨éƒ¨ä¿¡æ¯ | å¤šè½®è°ƒç”¨ã€å¯èƒ½ä¿¡æ¯æŸå¤± | è¶…é•¿æ–‡æ¡£ |

### æ¨èæ–¹æ¡ˆï¼šåˆ†å±‚ç­–ç•¥ï¼ˆæ™ºèƒ½é‡‡æ · + å¯é€‰ Map-Reduceï¼‰

```typescript
/**
 * åˆ†å±‚å†…å®¹è·å–ç­–ç•¥
 * 
 * Level 1: å¿«é€Ÿæ¨¡å¼ï¼ˆé»˜è®¤ï¼‰- æ™ºèƒ½é‡‡æ ·
 * Level 2: ç²¾å‡†æ¨¡å¼ï¼ˆå¯é€‰ï¼‰- Map-Reduce
 */

// ============================================
// Level 1: æ™ºèƒ½é‡‡æ ·ï¼ˆå·²æœ‰æ–¹æ¡ˆï¼Œé€‚åˆå¤§å¤šæ•°åœºæ™¯ï¼‰
// ============================================
// è§ä¸Šæ–‡ getSourceContentSmart()

// ============================================
// Level 2: Map-Reduce æ¨¡å¼ï¼ˆé«˜è´¨é‡åœºæ™¯ï¼‰
// ============================================

interface MapReduceOptions {
  notebookId: string
  sourceIds?: string[]
  type: 'summary' | 'outline' | 'quiz' | 'mindmap'
}

/**
 * Map-Reduce ç”Ÿæˆç­–ç•¥
 * 
 * æµç¨‹ï¼š
 * 1. Map: å¯¹æ¯ä¸ª Source å•ç‹¬ç”Ÿæˆæ‘˜è¦/è¦ç‚¹
 * 2. Reduce: åˆå¹¶æ‰€æœ‰æ‘˜è¦ï¼Œç”Ÿæˆæœ€ç»ˆäº§ç‰©
 * 
 * ä¼˜ç‚¹ï¼šè¦†ç›–å…¨éƒ¨å†…å®¹ï¼Œè´¨é‡æ›´é«˜
 * ç¼ºç‚¹ï¼šå¤šæ¬¡ API è°ƒç”¨ï¼Œè€—æ—¶ 2-3 å€
 */
async function generateWithMapReduce(options: MapReduceOptions): Promise<string> {
  const { notebookId, sourceIds, type } = options

  // 1. è·å–æ‰€æœ‰ Sources
  const sources = await prisma.source.findMany({
    where: {
      notebookId,
      status: 'ready',
      ...(sourceIds ? { id: { in: sourceIds } } : {}),
    },
    select: { id: true, title: true },
  })

  if (sources.length === 0) {
    throw new Error('NO_SOURCES')
  }

  // 2. Map é˜¶æ®µï¼šå¯¹æ¯ä¸ª Source ç”Ÿæˆä¸­é—´æ‘˜è¦
  const mapPrompt = getMapPrompt(type)
  const intermediateResults: string[] = []

  for (const source of sources) {
    // è·å–è¯¥ Source çš„æ‰€æœ‰ chunksï¼ˆé™åˆ¶æ•°é‡ï¼‰
    const chunks = await prisma.$queryRaw<Array<{ content: string }>>`
      SELECT content FROM document_chunks
      WHERE source_id = ${source.id}::uuid
      ORDER BY chunk_index ASC
      LIMIT 20
    `

    const sourceContent = chunks.map(c => c.content).join('\n\n')
    const truncated = truncateContextSmart(sourceContent)

    // ç”Ÿæˆè¯¥ Source çš„ä¸­é—´ç»“æœ
    const prompt = mapPrompt.replace('{source_title}', source.title)
                            .replace('{content}', truncated)
    
    const result = await generateWithTimeout(prompt, 30000)
    intermediateResults.push(`## ${source.title}\n${result}`)
  }

  // 3. Reduce é˜¶æ®µï¼šåˆå¹¶æ‰€æœ‰ä¸­é—´ç»“æœ
  const reducePrompt = getReducePrompt(type)
  const combinedInput = intermediateResults.join('\n\n---\n\n')
  const truncatedCombined = truncateContextSmart(combinedInput)

  const finalPrompt = reducePrompt.replace('{intermediate_results}', truncatedCombined)
  return await generateWithTimeout(finalPrompt, 60000)
}

/**
 * Map é˜¶æ®µ Promptï¼ˆé’ˆå¯¹å•ä¸ª Sourceï¼‰
 */
function getMapPrompt(type: string): string {
  const prompts: Record<string, string> = {
    summary: `è¯·ä¸ºä»¥ä¸‹æ¥æº "{source_title}" æå– 3-5 ä¸ªå…³é”®è¦ç‚¹ï¼š

{content}

è¾“å‡ºæ ¼å¼ï¼š
- è¦ç‚¹1ï¼š...
- è¦ç‚¹2ï¼š...
- è¦ç‚¹3ï¼š...`,

    outline: `è¯·ä¸ºä»¥ä¸‹æ¥æº "{source_title}" æå–ä¸»è¦ä¸»é¢˜å’Œç»“æ„ï¼š

{content}

è¾“å‡ºæ ¼å¼ï¼š
### {source_title}
- ä¸»é¢˜1
  - å­ä¸»é¢˜
- ä¸»é¢˜2`,

    quiz: `è¯·åŸºäºä»¥ä¸‹æ¥æº "{source_title}" ç”Ÿæˆ 2-3 é“é€‰æ‹©é¢˜ï¼ˆJSON æ ¼å¼ï¼‰ï¼š

{content}`,

    mindmap: `è¯·ä¸ºä»¥ä¸‹æ¥æº "{source_title}" æå–æ ¸å¿ƒæ¦‚å¿µå’Œå…³ç³»ï¼š

{content}

è¾“å‡ºæ ¼å¼ï¼š
- æ ¸å¿ƒæ¦‚å¿µï¼š...
- å­æ¦‚å¿µ1ï¼š...
- å­æ¦‚å¿µ2ï¼š...`,
  }
  return prompts[type] || prompts.summary
}

/**
 * Reduce é˜¶æ®µ Promptï¼ˆåˆå¹¶æ‰€æœ‰ä¸­é—´ç»“æœï¼‰
 */
function getReducePrompt(type: string): string {
  const prompts: Record<string, string> = {
    summary: `è¯·å°†ä»¥ä¸‹å¤šä¸ªæ¥æºçš„è¦ç‚¹åˆå¹¶ä¸ºä¸€ä»½å®Œæ•´çš„ç»“æ„åŒ–æ‘˜è¦ï¼š

{intermediate_results}

è¾“å‡ºæ ¼å¼ï¼š
## å†…å®¹æ‘˜è¦
### æ ¸å¿ƒä¸»é¢˜
...
### å…³é”®è¦ç‚¹
1. ...
2. ...
### æ€»ç»“
...`,

    outline: `è¯·å°†ä»¥ä¸‹å¤šä¸ªæ¥æºçš„ç»“æ„åˆå¹¶ä¸ºä¸€ä»½å®Œæ•´çš„çŸ¥è¯†å¤§çº²ï¼š

{intermediate_results}

è¾“å‡ºæ ¼å¼ï¼š
## çŸ¥è¯†å¤§çº²
### ä¸€ã€...
### äºŒã€...`,

    quiz: `è¯·å°†ä»¥ä¸‹é¢˜ç›®æ•´åˆä¸ºä¸€ä»½å®Œæ•´çš„æµ‹éªŒï¼ˆ5-10é¢˜ï¼ŒJSONæ ¼å¼ï¼‰ï¼š

{intermediate_results}`,

    mindmap: `è¯·å°†ä»¥ä¸‹æ¦‚å¿µæ•´åˆä¸ºä¸€ä»½æ€ç»´å¯¼å›¾ç»“æ„ï¼ˆJSONæ ¼å¼ï¼‰ï¼š

{intermediate_results}`,
  }
  return prompts[type] || prompts.summary
}
```

### æ–¹æ¡ˆ 3ï¼šè¯­ä¹‰èšç±»é‡‡æ ·ï¼ˆé«˜çº§ï¼‰

```typescript
/**
 * è¯­ä¹‰èšç±»é‡‡æ ·
 * 
 * åŸç†ï¼šä½¿ç”¨ embedding å¯¹ chunks è¿›è¡Œèšç±»ï¼Œæ¯ä¸ªèšç±»é€‰å–ä»£è¡¨æ€§æ ·æœ¬
 * ä¼˜ç‚¹ï¼šç¡®ä¿å†…å®¹å¤šæ ·æ€§ï¼Œé¿å…é‡å¤
 * ç¼ºç‚¹ï¼šéœ€è¦é¢å¤–çš„èšç±»è®¡ç®—
 */
async function getContentBySemanticClustering(
  notebookId: string,
  sourceIds?: string[],
  numClusters: number = 8
): Promise<string> {
  // 1. è·å–æ‰€æœ‰ chunks çš„ embedding
  const chunks = await prisma.$queryRaw<Array<{
    id: bigint
    content: string
    embedding: number[]
    source_title: string
  }>>`
    SELECT c.id, c.content, c.embedding, s.title as source_title
    FROM document_chunks c
    JOIN sources s ON c.source_id = s.id::uuid
    WHERE c.notebook_id = ${notebookId}::uuid
      AND s.status = 'ready'
      ${sourceIds ? Prisma.sql`AND s.id = ANY(${sourceIds}::uuid[])` : Prisma.empty}
    LIMIT 200
  `

  if (chunks.length <= numClusters) {
    // chunks æ•°é‡å°‘ï¼Œç›´æ¥è¿”å›å…¨éƒ¨
    return chunks.map((c, i) => 
      `### æ¥æº ${i + 1}: ${c.source_title}\n${c.content}`
    ).join('\n\n---\n\n')
  }

  // 2. K-Means èšç±»ï¼ˆç®€åŒ–ç‰ˆï¼Œä½¿ç”¨ä½™å¼¦ç›¸ä¼¼åº¦ï¼‰
  const clusters = kMeansClustering(
    chunks.map(c => c.embedding),
    numClusters
  )

  // 3. æ¯ä¸ªèšç±»é€‰å–æœ€æ¥è¿‘ä¸­å¿ƒçš„æ ·æœ¬
  const selectedIndices = clusters.map(cluster => {
    // æ‰¾åˆ°æœ€æ¥è¿‘èšç±»ä¸­å¿ƒçš„ç‚¹
    return cluster.memberIndices[0] // ç®€åŒ–ï¼šå–ç¬¬ä¸€ä¸ª
  })

  // 4. ç»„è£…ä¸Šä¸‹æ–‡
  const selectedChunks = selectedIndices.map(i => chunks[i])
  return selectedChunks.map((c, i) =>
    `### æ¥æº ${i + 1}: ${c.source_title}\n${c.content}`
  ).join('\n\n---\n\n')
}

/**
 * ç®€åŒ–çš„ K-Means èšç±»
 */
function kMeansClustering(
  embeddings: number[][],
  k: number
): Array<{ centroid: number[]; memberIndices: number[] }> {
  // å®ç°çœç•¥ï¼Œå¯ä½¿ç”¨ ml-kmeans åº“
  // npm install ml-kmeans
  return []
}
```

### æ¨èçš„æœ€ç»ˆæ–¹æ¡ˆï¼šè‡ªé€‚åº”ç­–ç•¥

```typescript
/**
 * è‡ªé€‚åº”å†…å®¹è·å–ç­–ç•¥
 * 
 * æ ¹æ®å†…å®¹é‡è‡ªåŠ¨é€‰æ‹©æœ€ä½³æ–¹æ¡ˆï¼š
 * - å°å‹ï¼ˆ<10 chunksï¼‰ï¼šå…¨é‡
 * - ä¸­å‹ï¼ˆ10-50 chunksï¼‰ï¼šæ™ºèƒ½é‡‡æ ·
 * - å¤§å‹ï¼ˆ>50 chunksï¼‰ï¼šMap-Reduce æˆ– è¯­ä¹‰èšç±»
 */
async function getContentAdaptive(
  notebookId: string,
  sourceIds?: string[],
  options?: {
    preferQuality?: boolean  // ä¼˜å…ˆè´¨é‡ï¼ˆä½¿ç”¨ Map-Reduceï¼‰
    maxTokens?: number
  }
): Promise<{ content: string; strategy: string; stats: ContentStats }> {
  const { preferQuality = false, maxTokens = 5000 } = options || {}

  // 1. ç»Ÿè®¡ chunks æ•°é‡
  const countResult = await prisma.$queryRaw<[{ count: bigint }]>`
    SELECT COUNT(*) as count 
    FROM document_chunks c
    JOIN sources s ON c.source_id = s.id::uuid
    WHERE c.notebook_id = ${notebookId}::uuid
      AND s.status = 'ready'
      ${sourceIds ? Prisma.sql`AND s.id = ANY(${sourceIds}::uuid[])` : Prisma.empty}
  `
  const totalChunks = Number(countResult[0].count)

  // 2. æ ¹æ®æ•°é‡é€‰æ‹©ç­–ç•¥
  let content: string
  let strategy: string

  if (totalChunks === 0) {
    throw new Error('NO_SOURCES')
  }

  if (totalChunks <= 10) {
    // å°å‹ï¼šå…¨é‡è·å–
    content = await getFullContent(notebookId, sourceIds)
    strategy = 'full'
  } else if (totalChunks <= 50 && !preferQuality) {
    // ä¸­å‹ï¼šæ™ºèƒ½é‡‡æ ·
    content = await getSourceContentSmart(notebookId, sourceIds)
    strategy = 'smart_sampling'
  } else if (preferQuality) {
    // å¤§å‹ + ä¼˜å…ˆè´¨é‡ï¼šMap-Reduceï¼ˆè¿”å›æ ‡è®°ï¼Œç”±è°ƒç”¨æ–¹å¤„ç†ï¼‰
    strategy = 'map_reduce'
    content = '' // Map-Reduce éœ€è¦ç‰¹æ®Šå¤„ç†
  } else {
    // å¤§å‹ï¼šæ™ºèƒ½é‡‡æ · + æˆªæ–­
    content = await getSourceContentSmart(notebookId, sourceIds)
    content = truncateContextSmart(content)
    strategy = 'smart_sampling_truncated'
  }

  return {
    content,
    strategy,
    stats: {
      totalChunks,
      usedChunks: strategy === 'full' ? totalChunks : Math.min(40, totalChunks),
      estimatedTokens: estimateTokens(content),
    }
  }
}

interface ContentStats {
  totalChunks: number
  usedChunks: number
  estimatedTokens: number
}
```

### UI å±‚é¢çš„ä¼˜åŒ–

```typescript
// åœ¨ Studio é¢æ¿ä¸­æ˜¾ç¤ºå†…å®¹ç»Ÿè®¡å’Œç­–ç•¥é€‰æ‹©

interface StudioActionsProps {
  notebookId: string
  readySourceCount: number
  totalChunks: number  // æ–°å¢ï¼šæ€» chunks æ•°
}

function StudioActions({ notebookId, readySourceCount, totalChunks }: StudioActionsProps) {
  const [preferQuality, setPreferQuality] = useState(false)

  // æ˜¾ç¤ºå†…å®¹é‡æç¤º
  const contentSizeHint = useMemo(() => {
    if (totalChunks <= 10) return 'å†…å®¹è¾ƒå°‘ï¼Œå°†ä½¿ç”¨å…¨éƒ¨èµ„æ–™'
    if (totalChunks <= 50) return 'å†…å®¹é€‚ä¸­ï¼Œå°†æ™ºèƒ½é‡‡æ ·å…³é”®éƒ¨åˆ†'
    return 'å†…å®¹è¾ƒå¤šï¼Œå»ºè®®å¼€å¯ç²¾å‡†æ¨¡å¼ä»¥è·å¾—æ›´å¥½æ•ˆæœ'
  }, [totalChunks])

  return (
    <div className="space-y-4">
      {/* å†…å®¹é‡æç¤º */}
      <div className="text-xs text-muted-foreground">
        {contentSizeHint}
        <span className="ml-2 text-slate-400">
          ({totalChunks} ä¸ªç‰‡æ®µ)
        </span>
      </div>

      {/* ç²¾å‡†æ¨¡å¼å¼€å…³ï¼ˆå¤§å†…å®¹é‡æ—¶æ˜¾ç¤ºï¼‰ */}
      {totalChunks > 50 && (
        <div className="flex items-center gap-2">
          <Switch
            checked={preferQuality}
            onCheckedChange={setPreferQuality}
          />
          <span className="text-sm">ç²¾å‡†æ¨¡å¼</span>
          <Tooltip title="ä½¿ç”¨ Map-Reduce ç­–ç•¥ï¼Œè¦†ç›–æ›´å…¨é¢ä½†è€—æ—¶æ›´é•¿">
            <HelpCircle className="h-4 w-4 text-muted-foreground" />
          </Tooltip>
        </div>
      )}

      {/* åŠ¨ä½œæŒ‰é’® */}
      <ActionButton type="summary" preferQuality={preferQuality} />
      <ActionButton type="outline" preferQuality={preferQuality} />
      <ActionButton type="quiz" preferQuality={preferQuality} />
      <ActionButton type="mindmap" preferQuality={preferQuality} />
    </div>
  )
}
```

---

## è¡¥å……çš„éªŒæ”¶æ ‡å‡†

### åœºæ™¯ 10ï¼šç”Ÿæˆæ¨¡å¼é€‰æ‹©
- [ ] Studio æ ‡é¢˜æ æ˜¾ç¤ºæ¨¡å¼é€‰æ‹©ä¸‹æ‹‰æ¡†
- [ ] ä¸‹æ‹‰æ¡†é€‰é¡¹ï¼š
  - âš¡ å¿«é€Ÿæ¨¡å¼ï¼šä½¿ç”¨æ™ºèƒ½é‡‡æ ·ï¼Œæ¯ä¸ª Source é‡‡æ ·å¼€å¤´å’Œç»“å°¾ chunksï¼Œé€Ÿåº¦å¿«ï¼ˆ5-15ç§’ï¼‰
  - ğŸ¯ ç²¾å‡†æ¨¡å¼ï¼šä½¿ç”¨ Map-Reduceï¼Œå¯¹æ¯ä¸ª Source å•ç‹¬å¤„ç†ååˆå¹¶ï¼Œè¦†ç›–æ›´å…¨é¢ï¼ˆ30-90ç§’ï¼‰
- [ ] é»˜è®¤é€‰ä¸­"å¿«é€Ÿæ¨¡å¼"
- [ ] åˆ‡æ¢æ¨¡å¼åï¼Œåç»­æ‰€æœ‰ç”Ÿæˆæ“ä½œä½¿ç”¨æ–°æ¨¡å¼
- [ ] ç²¾å‡†æ¨¡å¼ä¸‹æ˜¾ç¤ºé¢å¤–æç¤ºï¼š"ç²¾å‡†æ¨¡å¼è€—æ—¶è¾ƒé•¿ï¼Œä½†ç»“æœæ›´å…¨é¢"
- [ ] æ¨¡å¼é€‰æ‹©çŠ¶æ€ä¿å­˜åœ¨ localStorageï¼Œåˆ·æ–°åä¿ç•™

### åœºæ™¯ 11ï¼šå¤§å†…å®¹é‡å¤„ç†
- [ ] å½“ chunks æ•°é‡ > 50 æ—¶ï¼Œæ˜¾ç¤º"å†…å®¹è¾ƒå¤š"æç¤º
- [ ] å¿«é€Ÿæ¨¡å¼ä¸‹è‡ªåŠ¨ä½¿ç”¨æ™ºèƒ½é‡‡æ · + æˆªæ–­
- [ ] ç²¾å‡†æ¨¡å¼ä¸‹ä½¿ç”¨ Map-Reduce ç­–ç•¥
- [ ] ç”Ÿæˆå®Œæˆåæ˜¾ç¤ºä½¿ç”¨çš„ç­–ç•¥å’Œç»Ÿè®¡ä¿¡æ¯

### åœºæ™¯ 12ï¼šäº§ç‰©è´¨é‡åé¦ˆ
- [ ] æ¯ä¸ªäº§ç‰©ä¸‹æ–¹æ˜¾ç¤º"æœ‰å¸®åŠ©/æ²¡å¸®åŠ©"åé¦ˆæŒ‰é’®
- [ ] æ”¶é›†åé¦ˆç”¨äºåç»­ä¼˜åŒ– Prompt

---

## æ›´æ–°çš„æµ‹è¯•ç”¨ä¾‹

12. ä¸Šä¼  5 ä¸ªå¤§å‹ PDFï¼ˆ>100 chunksï¼‰â†’ æ˜¾ç¤º"å†…å®¹è¾ƒå¤š"æç¤º
13. å¼€å¯ç²¾å‡†æ¨¡å¼ç”Ÿæˆæ‘˜è¦ â†’ ä½¿ç”¨ Map-Reduceï¼Œè€—æ—¶æ›´é•¿ä½†è¦†ç›–æ›´å…¨
14. å…³é—­ç²¾å‡†æ¨¡å¼ç”Ÿæˆæ‘˜è¦ â†’ ä½¿ç”¨æ™ºèƒ½é‡‡æ ·ï¼Œé€Ÿåº¦æ›´å¿«
15. æŸ¥çœ‹ç”Ÿæˆç»Ÿè®¡ â†’ æ˜¾ç¤ºä½¿ç”¨çš„ç­–ç•¥å’Œ chunks æ•°é‡
