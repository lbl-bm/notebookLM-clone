// Prisma Schema for NotebookLM Clone
// åŸºäº PROJECT_SPEC.md ç¬¬ 5 ç« æ•°æ®æ¨¡å‹

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// æ ¸å¿ƒä¸šåŠ¡è¡¨ï¼ˆPrisma ç®¡ç†ï¼‰
// ============================================

model Notebook {
  id            String    @id @default(uuid())
  ownerId       String    // Supabase Auth user id
  title         String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastOpenedAt  DateTime  @default(now())

  // å…³è”
  sources              Source[]
  messages             Message[]
  artifacts            Artifact[]
  suggestedQuestions   SuggestedQuestion[]

  @@index([ownerId])
  @@index([lastOpenedAt])
  @@map("notebooks")
}

model Source {
  id                      String   @id @default(uuid())
  notebookId              String
  type                    String   // 'file' | 'url' | 'video'
  title                   String
  status                  String   @default("pending") // 'pending' | 'processing' | 'ready' | 'failed'
  storagePath             String?  // Supabase Storage è·¯å¾„
  url                     String?  // é“¾æ¥ URL
  meta                    Json?    // å…ƒä¿¡æ¯ï¼ˆé¡µæ•°ã€mimeã€æŠ“å–ä¿¡æ¯ç­‰ï¼‰
  
  // ğŸ”´ æ¶æ„é£é™© 8.2: é”™è¯¯æ¢å¤å­—æ®µ
  processingLog           Json?    // å¤„ç†æ—¥å¿—
  lastProcessedChunkIndex Int      @default(0) // æ–­ç‚¹ç»­ä¼ 
  retryCount              Int      @default(0)
  errorMessage            String?  // å¤±è´¥åŸå› 
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  // å…³è”
  notebook                Notebook @relation(fields: [notebookId], references: [id], onDelete: Cascade)

  @@index([notebookId])
  @@index([status])
  @@map("sources")
}

model Message {
  id         String   @id @default(uuid())
  notebookId String
  role       String   // 'user' | 'assistant' | 'system'
  content    String   @db.Text
  citations  Json?    // å¼•ç”¨ç»“æ„ï¼ˆè§ PROJECT_SPEC.md 6.2ï¼‰
  
  // ğŸ”´ æ–°å¢å­—æ®µï¼ˆPROJECT_SPEC.md 6.2 & 8.4ï¼‰
  answerMode String?  // 'grounded' | 'no_evidence' | nullï¼ˆç”¨æˆ·æ¶ˆæ¯ä¸º nullï¼‰
  metadata   Json?    // { retrievalMs, generationMs, model, topK, chunkCount }
  parentId   String?  // é¢„ç•™ï¼šæ¶ˆæ¯åˆ†æ”¯/é‡æ–°ç”Ÿæˆï¼ˆäºŒæœŸåŠŸèƒ½ï¼‰
  
  createdAt  DateTime @default(now())

  // å…³è”
  notebook   Notebook @relation(fields: [notebookId], references: [id], onDelete: Cascade)

  @@index([notebookId])
  @@index([createdAt])
  @@map("messages")
}

model Artifact {
  id         String   @id @default(uuid())
  notebookId String
  type       String   // 'summary' | 'outline' | 'quiz' | 'custom'
  input      Json     // promptã€source é€‰æ‹©ç­‰
  content    String   @db.Text // Markdown æˆ– JSON
  createdAt  DateTime @default(now())

  // å…³è”
  notebook   Notebook @relation(fields: [notebookId], references: [id], onDelete: Cascade)

  @@index([notebookId])
  @@index([createdAt])
  @@map("artifacts")
}

model PromptTemplate {
  id          String   @id @default(uuid())
  ownerId     String   // Supabase Auth user id
  name        String
  description String?
  template    String   @db.Text // åŒ…å« {{variable}} å ä½ç¬¦
  variables   String[] // ['topic', 'format']
  isSystem    Boolean  @default(false) // ç³»ç»Ÿé¢„è®¾ vs ç”¨æˆ·è‡ªå®šä¹‰
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([ownerId])
  @@index([isSystem])
  @@map("prompt_templates")
}

// ============================================
// å¤„ç†é˜Ÿåˆ—è¡¨ï¼ˆæ¶æ„é£é™© 8.6ï¼‰
// ============================================

model ProcessingQueue {
  id           BigInt   @id @default(autoincrement())
  sourceId     String
  status       String   @default("pending") // 'pending' | 'processing' | 'completed' | 'failed'
  priority     Int      @default(1)
  attempts     Int      @default(0)
  errorMessage String?
  createdAt    DateTime @default(now())
  startedAt    DateTime?
  completedAt  DateTime?

  @@index([status, priority, createdAt])
  @@map("processing_queue")
}

// ============================================
// å»ºè®®é—®é¢˜è¡¨ï¼ˆROADMAP Week 2ï¼‰
// ============================================

model SuggestedQuestion {
  id         String   @id @default(uuid())
  notebookId String
  question   String   @db.Text
  isUsed     Boolean  @default(false) // ç”¨æˆ·æ˜¯å¦å·²ç‚¹å‡»ä½¿ç”¨æ­¤é—®é¢˜
  createdAt  DateTime @default(now())

  // å…³è”
  notebook   Notebook @relation(fields: [notebookId], references: [id], onDelete: Cascade)

  @@index([notebookId])
  @@index([createdAt])
  @@map("suggested_questions")
}

// ============================================
// æ³¨æ„ï¼šå‘é‡è¡¨ document_chunks ä½¿ç”¨ SQL è¿ç§»åˆ›å»º
// è§ prisma/migrations/xxx_create_vector_table.sql
// ============================================
